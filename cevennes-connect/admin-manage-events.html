<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion √âv√©nements - Admin</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }

        .event-row {
            transition: all 0.3s ease;
        }

        .event-row:hover {
            background: #faf5ff;
            transform: translateX(4px);
        }

        .badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">
                    <i class="fas fa-calendar-edit mr-3 text-purple-600"></i>
                    Gestion des √âv√©nements
                </h1>
                <p class="text-gray-600 mt-2">√âditer, supprimer et g√©rer vos √©v√©nements</p>
            </div>
            <div class="flex gap-3">
                <button onclick="saveChanges()" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-xl transition-all">
                    <i class="fas fa-save mr-2"></i>Sauvegarder sur GitHub
                </button>
                <a href="admin.html" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-all inline-block">
                    <i class="fas fa-arrow-left mr-2"></i>Dashboard
                </a>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-8">
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl p-6">
                <div class="text-3xl font-bold text-purple-600" id="totalCount">0</div>
                <div class="text-sm text-gray-600 mt-1">Total</div>
            </div>
            <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-2xl p-6">
                <div class="text-2xl font-bold text-yellow-600" id="festivalCount">0</div>
                <div class="text-sm text-gray-600 mt-1">Festivals</div>
            </div>
            <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-6">
                <div class="text-2xl font-bold text-green-600" id="marcheCount">0</div>
                <div class="text-sm text-gray-600 mt-1">March√©s</div>
            </div>
            <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-2xl p-6">
                <div class="text-2xl font-bold text-red-600" id="cultureCount">0</div>
                <div class="text-sm text-gray-600 mt-1">Culture</div>
            </div>
            <div class="bg-gradient-to-br from-cyan-50 to-cyan-100 rounded-2xl p-6">
                <div class="text-2xl font-bold text-cyan-600" id="sportCount">0</div>
                <div class="text-sm text-gray-600 mt-1">Sport</div>
            </div>
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl p-6">
                <div class="text-2xl font-bold text-purple-600" id="atelierCount">0</div>
                <div class="text-sm text-gray-600 mt-1">Ateliers</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="mb-6 flex gap-4 items-center flex-wrap">
            <input
                type="text"
                id="searchInput"
                placeholder="üîç Rechercher un √©v√©nement..."
                class="flex-1 min-w-[300px] px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            >
            <select id="categoryFilter" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500">
                <option value="all">Toutes cat√©gories</option>
                <option value="festival">Festivals</option>
                <option value="marche">March√©s</option>
                <option value="culture">Culture</option>
                <option value="sport">Sport</option>
                <option value="atelier">Ateliers</option>
            </select>
            <select id="sortBy" class="px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500">
                <option value="date-asc">Date (croissant)</option>
                <option value="date-desc">Date (d√©croissant)</option>
                <option value="title">Titre (A-Z)</option>
            </select>
        </div>

        <!-- Events List -->
        <div class="bg-gray-50 rounded-2xl p-6">
            <div id="eventsList" class="space-y-3">
                <!-- Events will be loaded here -->
            </div>
            <div id="noResults" class="hidden text-center py-12 text-gray-500">
                <i class="fas fa-calendar-times text-4xl mb-4"></i>
                <p>Aucun √©v√©nement trouv√©</p>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6">√âditer l'√©v√©nement</h2>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editIndex">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Titre</label>
                    <input type="text" id="editTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cat√©gorie</label>
                        <select id="editCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                            <option value="festival">Festival</option>
                            <option value="marche">March√©</option>
                            <option value="culture">Culture</option>
                            <option value="sport">Sport</option>
                            <option value="atelier">Atelier</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prix</label>
                        <input type="text" id="editPrice" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Gratuit, 10‚Ç¨, etc.">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="editDescription" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input type="date" id="editDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Heure</label>
                        <input type="time" id="editTime" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Lieu</label>
                    <input type="text" id="editLocation" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Nom du lieu">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Adresse</label>
                    <input type="text" id="editAddress" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Ville (Code postal)">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Organisateur</label>
                        <input type="text" id="editOrganizer" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact</label>
                        <input type="text" id="editContact" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Email ou t√©l√©phone">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Site Web</label>
                    <input type="url" id="editWebsite" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors">
                        <i class="fas fa-check mr-2"></i>Enregistrer
                    </button>
                    <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allEvents = [];
        let filteredEvents = [];
        let hasChanges = false;

        // Load events data
        async function loadEvents() {
            try {
                const response = await fetch('data/events-data.json');
                allEvents = await response.json();
                updateStats();
                filterEvents();
            } catch (error) {
                console.error('Error loading events:', error);
                alert('Erreur lors du chargement des √©v√©nements');
            }
        }

        // Update stats
        function updateStats() {
            const counts = {
                total: allEvents.length,
                festival: 0,
                marche: 0,
                culture: 0,
                sport: 0,
                atelier: 0
            };

            allEvents.forEach(event => {
                if (counts.hasOwnProperty(event.category)) {
                    counts[event.category]++;
                }
            });

            document.getElementById('totalCount').textContent = counts.total;
            document.getElementById('festivalCount').textContent = counts.festival;
            document.getElementById('marcheCount').textContent = counts.marche;
            document.getElementById('cultureCount').textContent = counts.culture;
            document.getElementById('sportCount').textContent = counts.sport;
            document.getElementById('atelierCount').textContent = counts.atelier;
        }

        // Filter events
        function filterEvents() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            filteredEvents = allEvents.filter(event => {
                if (categoryFilter !== 'all' && event.category !== categoryFilter) return false;
                if (search && !event.title.toLowerCase().includes(search) &&
                    !event.location.toLowerCase().includes(search) &&
                    !event.description.toLowerCase().includes(search)) return false;
                return true;
            });

            // Sort
            if (sortBy === 'date-asc') {
                filteredEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
            } else if (sortBy === 'date-desc') {
                filteredEvents.sort((a, b) => new Date(b.date) - new Date(a.date));
            } else if (sortBy === 'title') {
                filteredEvents.sort((a, b) => a.title.localeCompare(b.title));
            }

            renderEvents();
        }

        // Render events
        function renderEvents() {
            const container = document.getElementById('eventsList');
            const noResults = document.getElementById('noResults');

            if (filteredEvents.length === 0) {
                container.innerHTML = '';
                noResults.classList.remove('hidden');
                return;
            }

            noResults.classList.add('hidden');
            container.innerHTML = filteredEvents.map((event, index) => {
                const realIndex = allEvents.findIndex(e => e.id === event.id);
                const categoryColors = {
                    festival: 'bg-yellow-100 text-yellow-700',
                    marche: 'bg-green-100 text-green-700',
                    culture: 'bg-red-100 text-red-700',
                    sport: 'bg-cyan-100 text-cyan-700',
                    atelier: 'bg-purple-100 text-purple-700'
                };
                const categoryIcons = {
                    festival: 'fa-music',
                    marche: 'fa-shopping-basket',
                    culture: 'fa-theater-masks',
                    sport: 'fa-running',
                    atelier: 'fa-tools'
                };

                const eventDate = new Date(event.date);
                const dateStr = eventDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
                const isPast = eventDate < new Date();

                return `
                    <div class="event-row bg-white rounded-xl p-4 flex items-center justify-between border border-gray-200 ${isPast ? 'opacity-50' : ''}">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="w-16 text-center">
                                    <div class="text-2xl font-bold text-purple-600">${eventDate.getDate()}</div>
                                    <div class="text-xs text-gray-500 uppercase">${eventDate.toLocaleDateString('fr-FR', { month: 'short' })}</div>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-gray-900">${event.title}</h3>
                                    <div class="flex items-center gap-2 text-sm text-gray-600 mt-1">
                                        <span class="badge ${categoryColors[event.category] || 'bg-gray-100 text-gray-700'}">
                                            <i class="fas ${categoryIcons[event.category] || 'fa-calendar'} mr-1"></i>
                                            ${getCategoryLabel(event.category)}
                                        </span>
                                        <span><i class="fas fa-map-marker-alt mr-1"></i>${event.location || event.address}</span>
                                        ${event.time ? `<span><i class="fas fa-clock mr-1"></i>${event.time}</span>` : ''}
                                        ${isPast ? '<span class="text-red-600 font-semibold">Pass√©</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editEvent(${realIndex})" class="bg-purple-100 text-purple-600 px-4 py-2 rounded-lg hover:bg-purple-200 transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="duplicateEvent(${realIndex})" class="bg-blue-100 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-200 transition-colors" title="Dupliquer">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="deleteEvent(${realIndex})" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Edit event
        function editEvent(index) {
            const event = allEvents[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('editTitle').value = event.title;
            document.getElementById('editCategory').value = event.category;
            document.getElementById('editDescription').value = event.description || '';
            document.getElementById('editDate').value = event.date;
            document.getElementById('editTime').value = event.time || '';
            document.getElementById('editLocation').value = event.location || '';
            document.getElementById('editAddress').value = event.address || '';
            document.getElementById('editPrice').value = event.price || '';
            document.getElementById('editOrganizer').value = event.organizer || '';
            document.getElementById('editContact').value = event.contact || '';
            document.getElementById('editWebsite').value = event.website || '';

            document.getElementById('editModal').classList.add('active');
        }

        // Close modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // Save edit
        document.getElementById('editForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const index = parseInt(document.getElementById('editIndex').value);

            allEvents[index] = {
                ...allEvents[index],
                title: document.getElementById('editTitle').value,
                category: document.getElementById('editCategory').value,
                description: document.getElementById('editDescription').value,
                date: document.getElementById('editDate').value,
                time: document.getElementById('editTime').value,
                location: document.getElementById('editLocation').value,
                address: document.getElementById('editAddress').value,
                price: document.getElementById('editPrice').value,
                organizer: document.getElementById('editOrganizer').value,
                contact: document.getElementById('editContact').value,
                website: document.getElementById('editWebsite').value
            };

            hasChanges = true;
            closeEditModal();
            updateStats();
            filterEvents();
        });

        // Duplicate event
        function duplicateEvent(index) {
            const event = { ...allEvents[index] };
            event.id = Date.now();
            event.title = event.title + ' (Copie)';

            allEvents.push(event);
            hasChanges = true;
            updateStats();
            filterEvents();
            alert('‚úÖ √âv√©nement dupliqu√© !');
        }

        // Delete event
        function deleteEvent(index) {
            const event = allEvents[index];
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer "${event.title}" ?`)) return;

            allEvents.splice(index, 1);
            hasChanges = true;
            updateStats();
            filterEvents();
        }

        // Save changes to GitHub
        async function saveChanges() {
            if (!hasChanges) {
                alert('Aucune modification √† sauvegarder');
                return;
            }

            if (!confirm('√ätes-vous s√ªr de vouloir sauvegarder les modifications sur GitHub ?')) return;

            try {
                const response = await fetch('/api/github-commit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filePath: 'cevennes-connect/data/events-data.json',
                        content: JSON.stringify(allEvents, null, 2),
                        commitMessage: `üóìÔ∏è Mise √† jour √©v√©nements via admin

${allEvents.length} √©v√©nements au total

ü§ñ Generated via admin-manage-events.html`
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erreur inconnue');
                }

                const result = await response.json();
                alert('‚úÖ Modifications sauvegard√©es sur GitHub !');
                hasChanges = false;
            } catch (error) {
                alert(`‚ùå Erreur lors de la sauvegarde :\n\n${error.message}`);
            }
        }

        // Utility functions
        function getCategoryLabel(category) {
            const labels = {
                festival: 'Festival',
                marche: 'March√©',
                culture: 'Culture',
                sport: 'Sport',
                atelier: 'Atelier'
            };
            return labels[category] || category;
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', filterEvents);
        document.getElementById('categoryFilter').addEventListener('change', filterEvents);
        document.getElementById('sortBy').addEventListener('change', filterEvents);

        // Close modal on background click
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') closeEditModal();
        });

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Load on start
        loadEvents();
    </script>
</body>
</html>
