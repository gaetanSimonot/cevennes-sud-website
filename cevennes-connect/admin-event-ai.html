<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artefact IA - √âv√©nements - C√©vennes Sud</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Configuration -->
    <script src="js/config.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }
        .drop-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 16px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8fafc;
            cursor: pointer;
        }
        .drop-zone.drag-over {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: scale(1.02);
        }
        .drop-zone:hover {
            border-color: #94a3b8;
            background: #f1f5f9;
        }
        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 12px;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .log-console {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 12px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
        }
        .log-success { color: #00ff00; }
        .log-error { color: #ff0000; }
        .log-warning { color: #ffaa00; }
        .log-info { color: #00aaff; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-bold text-gray-900 mb-2 text-center">
            <i class="fas fa-magic text-pink-600 mr-3"></i>
            Artefact IA - Extraction d'√âv√©nements
        </h1>
        <p class="text-center text-gray-600 mb-8">Glissez un screenshot, collez du texte ou un lien - L'IA extrait et reformule automatiquement !</p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Zone de Drop -->
            <div>
                <h2 class="text-2xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-upload text-blue-600 mr-2"></i>
                    Sources d'Information
                </h2>

                <!-- Drop Zone Images -->
                <div id="dropZone" class="drop-zone mb-6">
                    <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Glissez une image ici</h3>
                    <p class="text-gray-500 mb-4">ou cliquez pour s√©lectionner</p>
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                    <button onclick="document.getElementById('fileInput').click()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">
                        <i class="fas fa-folder-open mr-2"></i>Parcourir
                    </button>
                </div>

                <!-- Images Preview -->
                <div id="imagesPreview" class="hidden mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Images ajout√©es:</h3>
                    <div id="imagesList" class="flex flex-wrap gap-4"></div>
                </div>

                <!-- Text Area -->
                <div class="mb-6">
                    <label class="block text-lg font-semibold text-gray-700 mb-2">
                        <i class="fas fa-align-left text-green-600 mr-2"></i>
                        Texte ou Lien
                    </label>
                    <textarea id="textInput" rows="8" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Collez ici le texte de l'√©v√©nement, une URL Facebook, un lien vers une affiche..."></textarea>
                </div>

                <!-- Bouton Analyser -->
                <button id="analyzeBtn" onclick="analyzeEvent()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-xl font-semibold text-lg hover:shadow-xl transition-all">
                    <i class="fas fa-brain mr-2"></i>Analyser avec l'IA
                </button>
            </div>

            <!-- Zone de R√©sultat -->
            <div>
                <h2 class="text-2xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-robot text-purple-600 mr-2"></i>
                    Traitement IA
                </h2>

                <!-- Console de Log -->
                <div class="log-console mb-6" id="console">
                    <div class="log-info">ü§ñ Pr√™t √† analyser vos √©v√©nements avec OpenAI GPT-4 Vision</div>
                    <div class="log-info">üì∏ Vous pouvez ajouter des images d'affiches</div>
                    <div class="log-info">üìù Ou coller du texte / liens</div>
                    <div class="log-warning">‚ö†Ô∏è  L'analyse peut prendre 10-30 secondes</div>
                </div>

                <!-- R√©sultat JSON -->
                <div id="resultSection" class="hidden">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-code text-green-600 mr-2"></i>
                        √âv√©nement G√©n√©r√©
                    </h3>
                    <div class="bg-gray-900 text-green-400 p-6 rounded-xl overflow-x-auto mb-4" style="max-height: 400px;">
                        <pre id="jsonOutput" class="text-sm"></pre>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="copyJSON()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-700 transition-all">
                            <i class="fas fa-copy mr-2"></i>Copier JSON
                        </button>
                        <button onclick="downloadJSON()" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-green-700 transition-all">
                            <i class="fas fa-download mr-2"></i>T√©l√©charger
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8 text-center">
            <a href="evenements.html" class="inline-block bg-gray-200 text-gray-700 px-8 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-all">
                <i class="fas fa-arrow-left mr-2"></i>Retour aux √âv√©nements
            </a>
        </div>
    </div>

    <script>
        const OPENAI_API_KEY = CONFIG.OPENAI_API_KEY;
        let uploadedImages = [];
        let generatedEvent = null;

        // Drag & Drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedImages.push({
                            data: e.target.result,
                            name: file.name
                        });
                        displayImages();
                        log(`‚úì Image ajout√©e: ${file.name}`, 'success');
                    };
                    reader.readAsDataURL(file);
                } else {
                    log(`‚úó Fichier non support√©: ${file.name}`, 'error');
                }
            });
        }

        function displayImages() {
            const preview = document.getElementById('imagesPreview');
            const imagesList = document.getElementById('imagesList');

            preview.classList.remove('hidden');
            imagesList.innerHTML = uploadedImages.map((img, index) => `
                <div class="relative">
                    <img src="${img.data}" class="preview-image" alt="${img.name}">
                    <button onclick="removeImage(${index})" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-8 h-8 hover:bg-red-600 transition">
                        <i class="fas fa-times"></i>
                    </button>
                    <p class="text-xs text-gray-600 mt-2 text-center">${img.name}</p>
                </div>
            `).join('');
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            displayImages();
            if (uploadedImages.length === 0) {
                document.getElementById('imagesPreview').classList.add('hidden');
            }
            log(`‚úì Image supprim√©e`, 'info');
        }

        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = message;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }

        async function analyzeEvent() {
            const textInput = document.getElementById('textInput').value;
            const analyzeBtn = document.getElementById('analyzeBtn');

            if (uploadedImages.length === 0 && !textInput.trim()) {
                log('‚ùå Veuillez ajouter une image ou du texte', 'error');
                alert('Veuillez ajouter au moins une image ou du texte');
                return;
            }

            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyse en cours...';
            log('\nüöÄ D√©marrage de l\'analyse avec OpenAI GPT-4 Vision...', 'info');

            try {
                // Pr√©parer le prompt
                const prompt = `Tu es un assistant sp√©cialis√© dans l'extraction d'informations d'√©v√©nements.

Analyse les informations fournies (image d'affiche et/ou texte) et extrais les donn√©es suivantes pour cr√©er un √©v√©nement :

1. **title** (obligatoire) : Le titre de l'√©v√©nement
2. **category** : Cat√©gorie parmi: "concert", "festival", "marche", "exposition", "theatre", "sport", "conference", "autre"
3. **description** : Description d√©taill√©e et attrayante de l'√©v√©nement (2-3 phrases, reformul√©e de mani√®re professionnelle)
4. **date** : Date au format YYYY-MM-DD
5. **time** : Heure au format HH:MM (24h)
6. **location** : Lieu pr√©cis de l'√©v√©nement
7. **address** : Adresse compl√®te
8. **price** : Prix (ex: "Gratuit", "10‚Ç¨", "5-15‚Ç¨")
9. **organizer** : Organisateur de l'√©v√©nement
10. **contact** : Email ou t√©l√©phone de contact
11. **website** : Site web ou lien Facebook

${textInput ? `\n**Texte fourni :**\n${textInput}` : ''}

Retourne UNIQUEMENT un objet JSON valide sans texte additionnel, au format suivant :
{
  "title": "...",
  "category": "...",
  "description": "...",
  "date": "YYYY-MM-DD",
  "time": "HH:MM",
  "location": "...",
  "address": "...",
  "price": "...",
  "organizer": "...",
  "contact": "...",
  "website": "...",
  "image": ""
}

Si une information n'est pas disponible, utilise une cha√Æne vide "".`;

                // Pr√©parer les messages pour l'API
                const messages = [
                    {
                        role: 'user',
                        content: [
                            { type: 'text', text: prompt }
                        ]
                    }
                ];

                // Ajouter les images si pr√©sentes
                if (uploadedImages.length > 0) {
                    log(`üì∏ Envoi de ${uploadedImages.length} image(s) √† OpenAI...`, 'info');
                    uploadedImages.forEach(img => {
                        messages[0].content.push({
                            type: 'image_url',
                            image_url: { url: img.data }
                        });
                    });
                }

                // Appeler l'API OpenAI
                log('‚è≥ Analyse en cours avec GPT-4 Vision...', 'info');
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: messages,
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Erreur API OpenAI');
                }

                const data = await response.json();
                log('‚úÖ R√©ponse re√ßue de OpenAI', 'success');

                // Extraire le JSON de la r√©ponse
                let jsonText = data.choices[0].message.content.trim();

                // Nettoyer le texte (enlever les balises markdown si pr√©sentes)
                jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

                const eventData = JSON.parse(jsonText);

                // Ajouter l'ID et l'image
                eventData.id = Date.now();
                if (uploadedImages.length > 0) {
                    eventData.image = uploadedImages[0].data;
                } else {
                    eventData.image = 'https://images.unsplash.com/photo-1492684223066-81342ee5ff30?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';
                }

                // Ajouter coordonn√©es par d√©faut (Ganges)
                eventData.lat = 43.9339;
                eventData.lng = 3.7086;

                generatedEvent = eventData;

                // Afficher le r√©sultat
                document.getElementById('jsonOutput').textContent = JSON.stringify(eventData, null, 2);
                document.getElementById('resultSection').classList.remove('hidden');
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });

                log('‚úÖ √âv√©nement g√©n√©r√© avec succ√®s !', 'success');
                log(`üìÖ ${eventData.title}`, 'info');
                log(`üìç ${eventData.location}`, 'info');

            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                console.error('Erreur compl√®te:', error);
                alert(`Erreur lors de l'analyse: ${error.message}`);
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-brain mr-2"></i>Analyser avec l\'IA';
            }
        }

        function copyJSON() {
            const jsonText = document.getElementById('jsonOutput').textContent;
            navigator.clipboard.writeText(jsonText).then(() => {
                alert('‚úÖ JSON copi√© dans le presse-papier !');
            });
        }

        function downloadJSON() {
            if (!generatedEvent) return;

            const dataStr = JSON.stringify(generatedEvent, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const exportFileDefaultName = `event-${generatedEvent.id}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            log('‚úÖ Fichier JSON t√©l√©charg√© !', 'success');
            alert(`‚úÖ Fichier t√©l√©charg√©: ${exportFileDefaultName}\n\nüìù PROCHAINE √âTAPE:\n1. Va dans le dossier data/\n2. Ouvre events-data.json\n3. Ajoute cet √©v√©nement dans le tableau JSON\n4. Commit sur GitHub`);
        }
    </script>
</body>
</html>
