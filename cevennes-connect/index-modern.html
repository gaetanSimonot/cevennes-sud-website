<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sud Cévennes Connect</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-primary: #059669;
            --color-secondary: #ea580c;
            --color-accent: #7c3aed;
            --color-dark: #111827;
            --color-light: #f8fafc;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .font-display {
            font-family: 'Poppins', sans-serif;
        }

        /* Glassmorphism effects */
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Modern gradients */
        .gradient-primary {
            background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%);
        }

        .gradient-secondary {
            background: linear-gradient(135deg, #ea580c 0%, #f97316 50%, #fb923c 100%);
        }

        .gradient-accent {
            background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 50%, #a78bfa 100%);
        }

        .gradient-dark {
            background: linear-gradient(135deg, #111827 0%, #1f2937 50%, #374151 100%);
        }

        /* Animations avancées */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.4); }
            50% { box-shadow: 0 0 0 20px rgba(5, 150, 105, 0); }
        }

        .float-animation {
            animation: float 6s ease-in-out infinite;
        }

        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        /* Boutons modernes */
        .btn-modern {
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
            transform-style: preserve-3d;
        }

        .btn-modern:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-modern:hover:before {
            left: 100%;
        }

        .btn-modern:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .btn-modern.active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        /* Panneau moderne */
        .panel-modern {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px);
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: -20px 0 60px rgba(0,0,0,0.1);
        }

        /* Cards modernes */
        .card-modern {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
        }

        .card-modern:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
            border-color: rgba(5, 150, 105, 0.3);
        }

        /* Loading animation */
        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scrollbar moderne */
        .modern-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .modern-scrollbar::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 10px;
        }

        .modern-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #059669, #10b981);
            border-radius: 10px;
        }

        .modern-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #047857, #059669);
        }

        /* Icônes avec effects */
        .icon-glow {
            filter: drop-shadow(0 0 8px rgba(5, 150, 105, 0.3));
        }

        /* Responsive amélioré */
        @media (max-width: 768px) {
            .btn-modern {
                transform: none !important;
            }

            .btn-modern:hover {
                transform: none !important;
            }
        }

        /* Animation d'entrée */
        .fade-in-up {
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUp 0.8s ease-out forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stagger-1 { animation-delay: 0.1s; }
        .stagger-2 { animation-delay: 0.2s; }
        .stagger-3 { animation-delay: 0.3s; }
    </style>
</head>

<body class="min-h-screen overflow-hidden">
    <!-- Background pattern -->
    <div class="absolute inset-0 opacity-5" style="background-image: radial-gradient(circle at 2px 2px, #059669 2px, transparent 0); background-size: 40px 40px;"></div>

    <!-- Header flottant moderne -->
    <header class="fixed top-0 left-0 right-0 z-50 p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Logo et titre -->
            <div class="text-center mb-8 fade-in-up">
                <div class="inline-flex items-center justify-center w-16 h-16 gradient-primary rounded-2xl shadow-2xl mb-4 float-animation">
                    <i class="fas fa-mountain text-white text-2xl icon-glow"></i>
                </div>
                <h1 class="font-display font-black text-4xl lg:text-5xl text-transparent bg-clip-text bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 mb-2">
                    Sud Cévennes
                </h1>
                <p class="text-gray-600 font-medium text-lg">Votre territoire connecté</p>
            </div>

            <!-- Boutons principaux modernes -->
            <div class="flex flex-col lg:flex-row gap-6 justify-center items-center">
                <button id="btn-nous" class="btn-modern gradient-primary text-white px-10 py-6 rounded-3xl font-bold text-lg shadow-2xl flex items-center gap-4 min-w-[280px] group active fade-in-up stagger-1">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-300">
                        <i class="fas fa-store text-2xl"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-black text-xl">NOUS</div>
                        <div class="text-green-100 text-sm font-medium opacity-90">Acteurs locaux</div>
                    </div>
                    <i class="fas fa-arrow-right ml-auto group-hover:translate-x-1 transition-transform duration-300"></i>
                </button>

                <button id="btn-echangeons" class="btn-modern gradient-secondary text-white px-10 py-6 rounded-3xl font-bold text-lg shadow-2xl flex items-center gap-4 min-w-[280px] group fade-in-up stagger-2">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-300">
                        <i class="fas fa-handshake text-2xl"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-black text-xl">ÉCHANGEONS</div>
                        <div class="text-orange-100 text-sm font-medium opacity-90">Petites annonces</div>
                    </div>
                    <i class="fas fa-arrow-right ml-auto group-hover:translate-x-1 transition-transform duration-300"></i>
                </button>

                <button id="btn-moments" class="btn-modern gradient-accent text-white px-10 py-6 rounded-3xl font-bold text-lg shadow-2xl flex items-center gap-4 min-w-[280px] group fade-in-up stagger-3">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-300">
                        <i class="fas fa-calendar-star text-2xl"></i>
                    </div>
                    <div class="text-left">
                        <div class="font-black text-xl">DE BONS MOMENTS</div>
                        <div class="text-purple-100 text-sm font-medium opacity-90">Événements</div>
                    </div>
                    <i class="fas fa-arrow-right ml-auto group-hover:translate-x-1 transition-transform duration-300"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Carte centrale -->
    <main class="relative h-screen">
        <div id="map" class="w-full h-full relative z-10"></div>

        <!-- Overlay de loading -->
        <div id="loading" class="absolute inset-0 bg-white bg-opacity-90 backdrop-blur-sm flex items-center justify-center z-20">
            <div class="text-center">
                <div class="loader mb-4 mx-auto"></div>
                <p class="text-gray-600 font-medium">Chargement de la carte...</p>
            </div>
        </div>
    </main>

    <!-- Panneau latéral moderne -->
    <aside id="side-panel" class="fixed top-0 right-0 h-full w-full lg:w-[450px] panel-modern transform translate-x-full transition-transform duration-500 ease-out z-40">
        <!-- Header du panneau avec gradient -->
        <div id="panel-header" class="gradient-primary text-white p-8 relative overflow-hidden">
            <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.2) 1px, transparent 1px); background-size: 20px 20px;"></div>
            <div class="relative z-10 flex items-center justify-between">
                <div>
                    <h2 id="panel-title" class="font-display font-black text-2xl mb-1">Acteurs locaux</h2>
                    <p id="panel-subtitle" class="text-green-100 font-medium">Commerces et services</p>
                </div>
                <button id="close-panel" class="w-10 h-10 bg-white bg-opacity-20 rounded-xl flex items-center justify-center hover:bg-opacity-30 transition-all duration-300 hover:rotate-90">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Filtres secondaires modernes -->
        <div id="secondary-filters" class="p-6 bg-gradient-to-r from-white to-gray-50 border-b border-gray-100">
            <div class="flex flex-wrap gap-3" id="filter-buttons">
                <!-- Généré dynamiquement -->
            </div>
        </div>

        <!-- Compteur de résultats -->
        <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-white border-b border-gray-100">
            <p id="results-counter" class="text-sm font-semibold text-gray-600">
                <i class="fas fa-search mr-2 text-gray-400"></i>
                <span id="results-count">0</span> résultat(s)
            </p>
        </div>

        <!-- Contenu du panneau -->
        <div id="panel-content" class="flex-1 overflow-y-auto modern-scrollbar bg-gradient-to-b from-white to-gray-50">
            <!-- Généré dynamiquement -->
        </div>
    </aside>

    <!-- Bouton flottant moderne -->
    <button id="mobile-panel-btn" class="fixed bottom-8 right-8 w-16 h-16 gradient-primary rounded-2xl shadow-2xl z-50 flex items-center justify-center text-white text-xl hover:scale-110 transition-transform duration-300 pulse-glow lg:hidden">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Overlay pour mobile -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-30 hidden opacity-0 transition-opacity duration-300"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/data.js"></script>

    <script>
        // ==================== VARIABLES GLOBALES ====================
        let map;
        let currentMode = 'nous';
        let currentMarkers = [];
        let currentFilter = 'all';

        // Couleurs modernes par catégorie
        const modernColors = {
            restaurant: '#ef4444',
            sante: '#06b6d4',
            artisan: '#f59e0b',
            commerce: '#8b5cf6',
            hebergement: '#10b981',
            service_pro: '#6366f1',
            bienetre: '#ec4899',
            culture: '#7c3aed',
            sport: '#059669',
            famille: '#f97316',
            nature: '#84cc16',
            marche: '#8b5cf6',
            gastronomie: '#dc2626',
            default: '#6b7280'
        };

        // Configuration moderne des modes
        const modeConfig = {
            nous: {
                title: 'Acteurs locaux',
                subtitle: 'Commerces et services',
                gradient: 'gradient-primary',
                icon: 'fas fa-store',
                data: 'businesses',
                hasMap: true
            },
            echangeons: {
                title: 'Petites annonces',
                subtitle: 'Don, troc, vente',
                gradient: 'gradient-secondary',
                icon: 'fas fa-handshake',
                data: 'listings',
                hasMap: false
            },
            moments: {
                title: 'Événements',
                subtitle: 'Sorties et animations',
                gradient: 'gradient-accent',
                icon: 'fas fa-calendar-star',
                data: 'events',
                hasMap: true
            }
        };

        // ==================== INITIALISATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initialisation Sud Cévennes Connect...');

            setTimeout(() => {
                initMap();
                initEventListeners();
                switchMode('nous');

                // Masquer le loading
                setTimeout(() => {
                    document.getElementById('loading').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loading').style.display = 'none';
                    }, 300);
                }, 1000);
            }, 500);
        });

        // ==================== CARTE MODERNE ====================
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([43.9344, 3.6789], 11);

            // Style moderne pour les tuiles
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> © <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);

            // Contrôles modernes
            L.control.zoom({
                position: 'bottomleft'
            }).addTo(map);

            console.log('✅ Carte moderne initialisée');
        }

        // ==================== ÉVÉNEMENTS ====================
        function initEventListeners() {
            // Boutons principaux
            document.getElementById('btn-nous').addEventListener('click', () => switchMode('nous'));
            document.getElementById('btn-echangeons').addEventListener('click', () => switchMode('echangeons'));
            document.getElementById('btn-moments').addEventListener('click', () => switchMode('moments'));

            // Panneau
            document.getElementById('close-panel').addEventListener('click', closeSidePanel);
            document.getElementById('mobile-panel-btn').addEventListener('click', openSidePanel);
            document.getElementById('overlay').addEventListener('click', closeSidePanel);

            // Responsive
            window.addEventListener('resize', handleResize);
        }

        // ==================== GESTION DES MODES MODERNE ====================
        function switchMode(mode) {
            if (currentMode === mode) {
                toggleSidePanel();
                return;
            }

            console.log(`✨ Changement de mode: ${mode}`);
            currentMode = mode;

            updateButtonStates();
            updateSidePanel();
            updateMap();
            openSidePanel();
        }

        function updateButtonStates() {
            // Réinitialiser tous les boutons
            document.querySelectorAll('.btn-modern').forEach(btn => {
                btn.classList.remove('active');
                btn.style.opacity = '0.8';
            });

            // Activer le bouton courant
            const activeBtn = document.getElementById(`btn-${currentMode}`);
            activeBtn.classList.add('active');
            activeBtn.style.opacity = '1';
        }

        function updateSidePanel() {
            const config = modeConfig[currentMode];

            // Header avec gradient moderne
            const header = document.getElementById('panel-header');
            header.className = `${config.gradient} text-white p-8 relative overflow-hidden`;

            document.getElementById('panel-title').textContent = config.title;
            document.getElementById('panel-subtitle').textContent = config.subtitle;

            updateSecondaryFilters();
            updatePanelContent();
        }

        function updateSecondaryFilters() {
            const container = document.getElementById('filter-buttons');
            container.innerHTML = '';

            let filters = [];

            if (currentMode === 'nous') {
                filters = [
                    { key: 'all', label: 'Tous', emoji: '🏷️', color: 'bg-gray-100 text-gray-800' },
                    { key: 'restaurant', label: 'Restaurants', emoji: '🍽️', color: 'bg-red-100 text-red-800' },
                    { key: 'sante', label: 'Santé', emoji: '🏥', color: 'bg-cyan-100 text-cyan-800' },
                    { key: 'artisan', label: 'Artisans', emoji: '🔧', color: 'bg-amber-100 text-amber-800' },
                    { key: 'commerce', label: 'Commerce', emoji: '🛒', color: 'bg-violet-100 text-violet-800' },
                    { key: 'hebergement', label: 'Hébergement', emoji: '🏨', color: 'bg-emerald-100 text-emerald-800' },
                    { key: 'service_pro', label: 'Services Pro', emoji: '🎓', color: 'bg-indigo-100 text-indigo-800' },
                    { key: 'bienetre', label: 'Bien-être', emoji: '🌿', color: 'bg-pink-100 text-pink-800' }
                ];
            } else if (currentMode === 'moments') {
                filters = [
                    { key: 'all', label: 'Tous', emoji: '📅', color: 'bg-gray-100 text-gray-800' },
                    { key: 'culture', label: 'Culture', emoji: '🎭', color: 'bg-purple-100 text-purple-800' },
                    { key: 'sport', label: 'Sport', emoji: '⚽', color: 'bg-green-100 text-green-800' },
                    { key: 'famille', label: 'Famille', emoji: '👨‍👩‍👧‍👦', color: 'bg-orange-100 text-orange-800' },
                    { key: 'nature', label: 'Nature', emoji: '🌲', color: 'bg-lime-100 text-lime-800' },
                    { key: 'marche', label: 'Marchés', emoji: '🛒', color: 'bg-violet-100 text-violet-800' }
                ];
            }

            filters.forEach(filter => {
                const isActive = filter.key === currentFilter;
                const btn = document.createElement('button');
                btn.className = `px-4 py-2 rounded-xl font-semibold text-sm transition-all duration-300 hover:scale-105 ${isActive ? 'bg-gray-900 text-white shadow-lg' : filter.color + ' hover:shadow-md'}`;
                btn.innerHTML = `<span class="mr-2">${filter.emoji}</span>${filter.label}`;
                btn.addEventListener('click', () => filterContent(filter.key));
                container.appendChild(btn);
            });
        }

        function filterContent(filterKey) {
            currentFilter = filterKey;
            updateSecondaryFilters();
            updatePanelContent();
            updateMap();
        }

        function updatePanelContent() {
            const container = document.getElementById('panel-content');
            container.innerHTML = '<div class="p-8 text-center"><div class="loader mx-auto mb-4"></div><p class="text-gray-600">Chargement...</p></div>';

            setTimeout(() => {
                if (currentMode === 'nous') {
                    updateBusinessContent(container);
                } else if (currentMode === 'echangeons') {
                    updateListingsContent(container);
                } else if (currentMode === 'moments') {
                    updateEventsContent(container);
                }
            }, 300);
        }

        function updateBusinessContent(container) {
            if (typeof businesses === 'undefined') {
                container.innerHTML = '<div class="p-8 text-center text-gray-500">Données non disponibles</div>';
                return;
            }

            let filtered = businesses;
            if (currentFilter !== 'all') {
                filtered = businesses.filter(b => b.category === currentFilter);
            }

            document.getElementById('results-count').textContent = filtered.length;

            const html = filtered.map(business => `
                <div class="card-modern m-6 p-6 rounded-2xl cursor-pointer group" onclick="focusOnLocation(${business.lat}, ${business.lng})">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, ${modernColors[business.category] || modernColors.default}40, ${modernColors[business.category] || modernColors.default}20);">
                            ${getCategoryIcon(business.category)}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between mb-2">
                                <h3 class="font-bold text-lg text-gray-900 group-hover:text-green-600 transition-colors truncate">${business.name}</h3>
                                ${business.premium === 'premium' ? '<span class="bg-gradient-to-r from-yellow-400 to-yellow-500 text-white text-xs px-3 py-1 rounded-full font-bold shadow-md"><i class="fas fa-crown mr-1"></i>Premium</span>' : ''}
                            </div>
                            <p class="text-gray-600 text-sm mb-3 line-clamp-2">${business.description}</p>
                            <div class="space-y-2 text-sm text-gray-500">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-map-marker-alt text-green-500 w-4"></i>
                                    <span class="truncate">${business.address}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-phone text-blue-500 w-4"></i>
                                    <a href="tel:${business.phone}" class="text-blue-600 hover:text-blue-700 font-medium">${business.phone}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html || '<div class="p-8 text-center text-gray-500">Aucun résultat</div>';
        }

        function updateListingsContent(container) {
            const sampleListings = [
                {
                    title: "MacBook Pro 13\" - État parfait",
                    description: "MacBook Pro 2021, 16GB RAM, 512GB SSD. Utilisé 6 mois, facture disponible.",
                    price: "1 250€",
                    type: "vente",
                    location: "Ganges",
                    category: "tech"
                },
                {
                    title: "Cours de yoga au domicile",
                    description: "Professeure certifiée propose cours particuliers ou en petit groupe. Tous niveaux.",
                    price: "40€/séance",
                    type: "service",
                    location: "Saint-Bauzille-de-Putois",
                    category: "service"
                },
                {
                    title: "Plants potager bio à donner",
                    description: "Surplus de plants : tomates, courgettes, aubergines. Variétés anciennes et bio.",
                    price: "Gratuit",
                    type: "don",
                    location: "Sumène",
                    category: "jardin"
                }
            ];

            document.getElementById('results-count').textContent = sampleListings.length;

            const html = sampleListings.map(listing => `
                <div class="card-modern m-6 p-6 rounded-2xl group">
                    <div class="flex items-start justify-between mb-3">
                        <h3 class="font-bold text-lg text-gray-900 flex-1">${listing.title}</h3>
                        <span class="font-bold text-xl text-orange-600 ml-4">${listing.price}</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4 line-clamp-2">${listing.description}</p>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-sm text-gray-500">
                            <i class="fas fa-map-marker-alt text-orange-500"></i>
                            <span>${listing.location}</span>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-orange-100 text-orange-800 capitalize">${listing.type}</span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function updateEventsContent(container) {
            if (typeof events === 'undefined') {
                container.innerHTML = '<div class="p-8 text-center text-gray-500">Données non disponibles</div>';
                return;
            }

            let filtered = events;
            if (currentFilter !== 'all') {
                filtered = events.filter(e => e.category === currentFilter);
            }

            document.getElementById('results-count').textContent = filtered.length;

            const html = filtered.map(event => `
                <div class="card-modern m-6 p-6 rounded-2xl cursor-pointer group" onclick="focusOnLocation(${event.lat || 43.9344}, ${event.lng || 3.6789})">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, ${modernColors[event.category] || modernColors.default}40, ${modernColors[event.category] || modernColors.default}20);">
                            ${getEventIcon(event.category)}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-lg text-gray-900 group-hover:text-purple-600 transition-colors mb-2">${event.title}</h3>
                            <p class="text-gray-600 text-sm mb-3 line-clamp-2">${event.description}</p>
                            <div class="space-y-2 text-sm text-gray-500">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-calendar text-purple-500 w-4"></i>
                                    <span>${formatDate(event.date)} • ${event.time}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-map-marker-alt text-purple-500 w-4"></i>
                                    <span class="truncate">${event.location}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-ticket-alt text-purple-500 w-4"></i>
                                    <span class="font-semibold text-purple-600">${event.price}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html || '<div class="p-8 text-center text-gray-500">Aucun résultat</div>';
        }

        // ==================== CARTE ET MARKERS ====================
        function updateMap() {
            currentMarkers.forEach(marker => map.removeLayer(marker));
            currentMarkers = [];

            if (currentMode === 'nous') {
                updateBusinessMarkers();
            } else if (currentMode === 'moments') {
                updateEventMarkers();
            }
        }

        function updateBusinessMarkers() {
            if (typeof businesses === 'undefined') return;

            let filtered = businesses;
            if (currentFilter !== 'all') {
                filtered = businesses.filter(b => b.category === currentFilter);
            }

            filtered.forEach(business => {
                const marker = L.marker([business.lat, business.lng], {
                    icon: createModernIcon(business.category, getCategoryIcon(business.category))
                }).addTo(map);

                marker.bindPopup(`
                    <div class="p-4 min-w-[300px] font-sans">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center text-xl" style="background: linear-gradient(135deg, ${modernColors[business.category]}40, ${modernColors[business.category]}20);">
                                ${getCategoryIcon(business.category)}
                            </div>
                            <h3 class="font-bold text-lg text-gray-900">${business.name}</h3>
                        </div>
                        <p class="text-gray-600 text-sm mb-3">${business.description.substring(0, 100)}...</p>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2 text-gray-500">
                                <i class="fas fa-map-marker-alt text-green-500"></i>
                                <span>${business.address}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-phone text-blue-500"></i>
                                <a href="tel:${business.phone}" class="text-blue-600 hover:text-blue-700 font-medium">${business.phone}</a>
                            </div>
                        </div>
                        ${business.premium === 'premium' ? '<div class="mt-3"><span class="bg-gradient-to-r from-yellow-400 to-yellow-500 text-white text-xs px-3 py-1 rounded-full font-bold"><i class="fas fa-crown mr-1"></i>Premium</span></div>' : ''}
                    </div>
                `);

                currentMarkers.push(marker);
            });
        }

        function updateEventMarkers() {
            if (typeof events === 'undefined') return;

            let filtered = events;
            if (currentFilter !== 'all') {
                filtered = events.filter(e => e.category === currentFilter);
            }

            filtered.forEach(event => {
                const lat = event.lat || 43.9344 + (Math.random() - 0.5) * 0.1;
                const lng = event.lng || 3.6789 + (Math.random() - 0.5) * 0.1;

                const marker = L.marker([lat, lng], {
                    icon: createModernIcon('event', getEventIcon(event.category))
                }).addTo(map);

                marker.bindPopup(`
                    <div class="p-4 min-w-[300px] font-sans">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center text-xl" style="background: linear-gradient(135deg, ${modernColors[event.category]}40, ${modernColors[event.category]}20);">
                                ${getEventIcon(event.category)}
                            </div>
                            <h3 class="font-bold text-lg text-gray-900">${event.title}</h3>
                        </div>
                        <p class="text-gray-600 text-sm mb-3">${event.description.substring(0, 100)}...</p>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2 text-gray-500">
                                <i class="fas fa-calendar text-purple-500"></i>
                                <span>${formatDate(event.date)} • ${event.time}</span>
                            </div>
                            <div class="flex items-center gap-2 text-gray-500">
                                <i class="fas fa-map-marker-alt text-purple-500"></i>
                                <span>${event.location}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-ticket-alt text-purple-500"></i>
                                <span class="font-bold text-purple-600">${event.price}</span>
                            </div>
                        </div>
                    </div>
                `);

                currentMarkers.push(marker);
            });
        }

        // ==================== PANNEAU LATERAL ====================
        function openSidePanel() {
            const panel = document.getElementById('side-panel');
            const overlay = document.getElementById('overlay');

            panel.style.transform = 'translateX(0)';

            if (window.innerWidth <= 1024) {
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.style.opacity = '1', 10);
                document.getElementById('mobile-panel-btn').style.display = 'none';
            }
        }

        function closeSidePanel() {
            const panel = document.getElementById('side-panel');
            const overlay = document.getElementById('overlay');

            panel.style.transform = 'translateX(100%)';
            overlay.style.opacity = '0';

            setTimeout(() => {
                overlay.classList.add('hidden');
                if (window.innerWidth <= 1024) {
                    document.getElementById('mobile-panel-btn').style.display = 'flex';
                }
            }, 300);
        }

        function toggleSidePanel() {
            const panel = document.getElementById('side-panel');
            if (panel.style.transform === 'translateX(0px)') {
                closeSidePanel();
            } else {
                openSidePanel();
            }
        }

        function handleResize() {
            if (window.innerWidth > 1024) {
                document.getElementById('overlay').classList.add('hidden');
                document.getElementById('mobile-panel-btn').style.display = 'none';
            }
        }

        // ==================== UTILITAIRES ====================
        function createModernIcon(category, emoji) {
            const color = modernColors[category] || modernColors.default;
            return L.divIcon({
                html: `
                    <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl font-bold text-white shadow-2xl transform hover:scale-110 transition-transform duration-200" style="background: linear-gradient(135deg, ${color}, ${color}dd); border: 3px solid white;">
                        ${emoji}
                    </div>
                `,
                className: 'custom-modern-marker',
                iconSize: [48, 48],
                iconAnchor: [24, 24]
            });
        }

        function getCategoryIcon(category) {
            const icons = {
                restaurant: '🍽️', sante: '🏥', artisan: '🔧', commerce: '🛒',
                hebergement: '🏨', service_pro: '🎓', bienetre: '🌿'
            };
            return icons[category] || '📍';
        }

        function getEventIcon(category) {
            const icons = {
                culture: '🎭', sport: '⚽', famille: '👨‍👩‍👧‍👦', nature: '🌲',
                marche: '🛒', gastronomie: '🍷'
            };
            return icons[category] || '📅';
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR', {
                weekday: 'short', day: 'numeric', month: 'short'
            });
        }

        function focusOnLocation(lat, lng) {
            map.setView([lat, lng], 16);
            if (window.innerWidth <= 1024) {
                setTimeout(() => closeSidePanel(), 500);
            }
        }
    </script>
</body>
</html>