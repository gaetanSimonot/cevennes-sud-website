<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sud Cévennes Connect</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-primary: #059669;
            --color-secondary: #ea580c;
            --color-accent: #7c3aed;
            --color-dark: #111827;
            --color-light: #f8fafc;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .font-display {
            font-family: 'Poppins', sans-serif;
        }

        /* Glassmorphism effects */
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Modern gradients */
        .gradient-primary { background: linear-gradient(135deg, #059669 0%, #10b981 50%, #34d399 100%); }
        .gradient-secondary { background: linear-gradient(135deg, #ea580c 0%, #f97316 50%, #fb923c 100%); }
        .gradient-accent { background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 50%, #a78bfa 100%); }
        .gradient-dark { background: linear-gradient(135deg, #111827 0%, #1f2937 50%, #374151 100%); }

        /* Animation des boutons intelligents */
        .btn-smart {
            transition: all 0.6s cubic-bezier(0.23, 1, 0.320, 1);
            transform-origin: center;
        }

        .btn-smart.active {
            transform: scale(1.05);
            z-index: 10;
        }

        .btn-smart.inactive {
            transform: scale(0.75);
            opacity: 0.6;
        }

        .btn-smart:hover:not(.active) {
            transform: scale(0.85);
            opacity: 0.8;
        }

        /* Container des boutons qui se réorganise */
        .buttons-container {
            transition: all 0.8s cubic-bezier(0.23, 1, 0.320, 1);
        }

        .buttons-container.compact {
            gap: 0.5rem;
        }

        /* Popup moderne */
        .popup-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
        }

        .popup-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            transition: all 0.5s cubic-bezier(0.23, 1, 0.320, 1);
            transform: scale(0.8) translateY(50px);
            opacity: 0;
        }

        .popup-content.open {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        /* Animations avancées */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.4); }
            50% { box-shadow: 0 0 0 20px rgba(5, 150, 105, 0); }
        }

        .float-animation { animation: float 6s ease-in-out infinite; }
        .pulse-glow { animation: pulse-glow 2s infinite; }

        /* Cards modernes */
        .card-modern {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
        }

        .card-modern:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
            border-color: rgba(5, 150, 105, 0.3);
        }

        /* Scrollbar moderne */
        .modern-scrollbar::-webkit-scrollbar { width: 6px; }
        .modern-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 10px; }
        .modern-scrollbar::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #059669, #10b981); border-radius: 10px; }

        /* Filtres avec animations */
        .filter-tab {
            transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
            position: relative;
            overflow: hidden;
        }

        .filter-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .filter-tab:hover::before {
            left: 100%;
        }

        .filter-tab.active {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* Animation d'entrée */
        .fade-in-up {
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUp 0.8s ease-out forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stagger-1 { animation-delay: 0.1s; }
        .stagger-2 { animation-delay: 0.2s; }
        .stagger-3 { animation-delay: 0.3s; }
    </style>
</head>

<body class="min-h-screen overflow-hidden">
    <!-- Background pattern -->
    <div class="absolute inset-0 opacity-5" style="background-image: radial-gradient(circle at 2px 2px, #059669 2px, transparent 0); background-size: 40px 40px;"></div>

    <!-- Header adaptatif moderne -->
    <header class="fixed top-0 left-0 right-0 z-50 transition-all duration-800 ease-out" id="main-header">
        <div class="max-w-7xl mx-auto p-6">
            <!-- Logo et titre -->
            <div class="text-center mb-8 fade-in-up" id="logo-section">
                <div class="inline-flex items-center justify-center w-16 h-16 gradient-primary rounded-2xl shadow-2xl mb-4 float-animation">
                    <i class="fas fa-mountain text-white text-2xl"></i>
                </div>
                <h1 class="font-display font-black text-4xl lg:text-5xl text-transparent bg-clip-text bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 mb-2">
                    Sud Cévennes
                </h1>
                <p class="text-gray-600 font-medium text-lg">Votre territoire connecté</p>
            </div>

            <!-- Boutons intelligents qui se réorganisent -->
            <div class="buttons-container flex flex-col lg:flex-row gap-6 justify-center items-center" id="buttons-container">
                <button id="btn-nous" class="btn-smart gradient-primary text-white px-10 py-6 rounded-3xl font-bold text-lg shadow-2xl flex items-center gap-4 min-w-[280px] group active fade-in-up stagger-1">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-300">
                        <i class="fas fa-store text-2xl"></i>
                    </div>
                    <div class="text-left btn-text">
                        <div class="font-black text-xl">NOUS</div>
                        <div class="text-green-100 text-sm font-medium opacity-90">Acteurs locaux</div>
                    </div>
                    <i class="fas fa-arrow-right ml-auto group-hover:translate-x-1 transition-transform duration-300 btn-arrow"></i>
                </button>

                <button id="btn-echangeons" class="btn-smart gradient-secondary text-white px-10 py-6 rounded-3xl font-bold text-lg shadow-2xl flex items-center gap-4 min-w-[280px] group inactive fade-in-up stagger-2">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-300">
                        <i class="fas fa-handshake text-2xl"></i>
                    </div>
                    <div class="text-left btn-text">
                        <div class="font-black text-xl">ÉCHANGEONS</div>
                        <div class="text-orange-100 text-sm font-medium opacity-90">Petites annonces</div>
                    </div>
                    <i class="fas fa-arrow-right ml-auto group-hover:translate-x-1 transition-transform duration-300 btn-arrow"></i>
                </button>

                <button id="btn-moments" class="btn-smart gradient-accent text-white px-10 py-6 rounded-3xl font-bold text-lg shadow-2xl flex items-center gap-4 min-w-[280px] group inactive fade-in-up stagger-3">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center group-hover:rotate-12 transition-transform duration-300">
                        <i class="fas fa-calendar-star text-2xl"></i>
                    </div>
                    <div class="text-left btn-text">
                        <div class="font-black text-xl">DE BONS MOMENTS</div>
                        <div class="text-purple-100 text-sm font-medium opacity-90">Événements</div>
                    </div>
                    <i class="fas fa-arrow-right ml-auto group-hover:translate-x-1 transition-transform duration-300 btn-arrow"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Carte centrale -->
    <main class="relative h-screen">
        <div id="map" class="w-full h-full relative z-10"></div>
    </main>

    <!-- Panneau latéral moderne (pour NOUS et MOMENTS) -->
    <aside id="side-panel" class="fixed top-0 right-0 h-full w-full lg:w-[450px] glass-strong transform translate-x-full transition-transform duration-500 ease-out z-40">
        <div id="panel-header" class="gradient-primary text-white p-8 relative overflow-hidden">
            <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.2) 1px, transparent 1px); background-size: 20px 20px;"></div>
            <div class="relative z-10 flex items-center justify-between">
                <div>
                    <h2 id="panel-title" class="font-display font-black text-2xl mb-1">Acteurs locaux</h2>
                    <p id="panel-subtitle" class="text-green-100 font-medium">Commerces et services</p>
                </div>
                <button id="close-panel" class="w-10 h-10 bg-white bg-opacity-20 rounded-xl flex items-center justify-center hover:bg-opacity-30 transition-all duration-300 hover:rotate-90">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <div id="secondary-filters" class="p-6 bg-gradient-to-r from-white to-gray-50 border-b border-gray-100">
            <div class="flex flex-wrap gap-3" id="filter-buttons"></div>
        </div>

        <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-white border-b border-gray-100">
            <p class="text-sm font-semibold text-gray-600">
                <i class="fas fa-search mr-2 text-gray-400"></i>
                <span id="results-count">0</span> résultat(s)
            </p>
        </div>

        <div id="panel-content" class="flex-1 overflow-y-auto modern-scrollbar bg-gradient-to-b from-white to-gray-50"></div>
    </aside>

    <!-- POPUP MODERNE POUR ÉCHANGEONS -->
    <div id="popup-echangeons" class="fixed inset-0 popup-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="popup-content w-full max-w-6xl max-h-[90vh] rounded-3xl overflow-hidden">
            <!-- Header de la popup -->
            <div class="gradient-secondary text-white p-8 relative overflow-hidden">
                <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.2) 1px, transparent 1px); background-size: 20px 20px;"></div>
                <div class="relative z-10 flex items-center justify-between">
                    <div>
                        <h2 class="font-display font-black text-3xl mb-2 flex items-center gap-3">
                            <i class="fas fa-handshake text-4xl"></i>
                            ÉCHANGEONS
                        </h2>
                        <p class="text-orange-100 font-medium text-lg">Petites annonces • Don, troc, vente</p>
                    </div>
                    <button id="close-popup" class="w-12 h-12 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center hover:bg-opacity-30 transition-all duration-300 hover:rotate-90">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>

            <!-- Contenu de la popup avec filtres -->
            <div class="flex h-[70vh]">
                <!-- Filtres à gauche -->
                <div class="w-80 bg-gradient-to-b from-gray-50 to-white border-r border-gray-200 p-6 overflow-y-auto modern-scrollbar">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">
                        <i class="fas fa-filter mr-2 text-orange-500"></i>
                        Filtres
                    </h3>

                    <!-- Filtres par type -->
                    <div class="mb-6">
                        <h4 class="font-semibold mb-3 text-gray-700">Type d'annonce</h4>
                        <div class="space-y-2">
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-orange-100 text-orange-800 font-semibold active" data-filter="all">
                                <i class="fas fa-list mr-2"></i>Toutes les annonces
                            </button>
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" data-filter="vente">
                                <i class="fas fa-tag mr-2 text-green-500"></i>Vente
                            </button>
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" data-filter="don">
                                <i class="fas fa-gift mr-2 text-blue-500"></i>Don
                            </button>
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" data-filter="troc">
                                <i class="fas fa-exchange-alt mr-2 text-purple-500"></i>Troc
                            </button>
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" data-filter="recherche">
                                <i class="fas fa-search mr-2 text-orange-500"></i>Recherche
                            </button>
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" data-filter="service">
                                <i class="fas fa-handshake mr-2 text-indigo-500"></i>Service
                            </button>
                        </div>
                    </div>

                    <!-- Filtres par catégorie -->
                    <div class="mb-6">
                        <h4 class="font-semibold mb-3 text-gray-700">Catégories</h4>
                        <div class="space-y-2">
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" data-category="vehicules">
                                <i class="fas fa-car mr-2 text-red-500"></i>Véhicules
                            </button>
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" data-category="maison">
                                <i class="fas fa-home mr-2 text-green-500"></i>Maison & Jardin
                            </button>
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" data-category="tech">
                                <i class="fas fa-laptop mr-2 text-blue-500"></i>High-tech
                            </button>
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" data-category="mode">
                                <i class="fas fa-tshirt mr-2 text-pink-500"></i>Mode
                            </button>
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" data-category="loisirs">
                                <i class="fas fa-gamepad mr-2 text-purple-500"></i>Loisirs & Sport
                            </button>
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" data-category="enfants">
                                <i class="fas fa-baby mr-2 text-yellow-500"></i>Enfants
                            </button>
                        </div>
                    </div>

                    <!-- Filtres par prix -->
                    <div class="mb-6">
                        <h4 class="font-semibold mb-3 text-gray-700">Prix</h4>
                        <div class="space-y-2">
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" data-price="free">
                                <i class="fas fa-gift mr-2 text-green-500"></i>Gratuit
                            </button>
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" data-price="under-50">
                                <i class="fas fa-euro-sign mr-2 text-blue-500"></i>Moins de 50€
                            </button>
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" data-price="50-200">
                                <i class="fas fa-euro-sign mr-2 text-yellow-500"></i>50€ - 200€
                            </button>
                            <button class="filter-tab w-full text-left px-4 py-2 rounded-xl bg-white border border-gray-200 text-gray-700 hover:bg-gray-50" data-price="over-200">
                                <i class="fas fa-euro-sign mr-2 text-red-500"></i>Plus de 200€
                            </button>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="border-t border-gray-200 pt-4">
                        <button class="w-full px-4 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl font-semibold hover:from-orange-600 hover:to-orange-700 transition-all duration-300">
                            <i class="fas fa-plus mr-2"></i>Déposer une annonce
                        </button>
                    </div>
                </div>

                <!-- Liste des annonces à droite -->
                <div class="flex-1 p-6 overflow-y-auto modern-scrollbar bg-gradient-to-b from-white to-gray-50">
                    <div class="mb-4 flex items-center justify-between">
                        <p class="text-sm font-semibold text-gray-600">
                            <i class="fas fa-bullhorn mr-2 text-orange-500"></i>
                            <span id="popup-results-count">12</span> annonce(s)
                        </p>
                        <div class="flex gap-2">
                            <button class="px-3 py-1 text-sm bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                <i class="fas fa-sort-amount-down mr-1"></i>Plus récentes
                            </button>
                        </div>
                    </div>

                    <div id="popup-listings-content" class="space-y-4">
                        <!-- Généré dynamiquement -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bouton flottant -->
    <button id="mobile-panel-btn" class="fixed bottom-8 right-8 w-16 h-16 gradient-primary rounded-2xl shadow-2xl z-50 flex items-center justify-center text-white text-xl hover:scale-110 transition-transform duration-300 pulse-glow lg:hidden">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/data.js"></script>

    <script>
        // ==================== VARIABLES GLOBALES ====================
        let map;
        let currentMode = 'nous';
        let currentMarkers = [];
        let currentFilter = 'all';
        let isCompactMode = false;

        // Couleurs modernes
        const modernColors = {
            restaurant: '#ef4444', sante: '#06b6d4', artisan: '#f59e0b', commerce: '#8b5cf6',
            hebergement: '#10b981', service_pro: '#6366f1', bienetre: '#ec4899',
            culture: '#7c3aed', sport: '#059669', famille: '#f97316', nature: '#84cc16',
            marche: '#8b5cf6', gastronomie: '#dc2626', default: '#6b7280'
        };

        const modeConfig = {
            nous: { title: 'Acteurs locaux', subtitle: 'Commerces et services', gradient: 'gradient-primary', hasMap: true },
            echangeons: { title: 'Petites annonces', subtitle: 'Don, troc, vente', gradient: 'gradient-secondary', hasMap: false },
            moments: { title: 'Événements', subtitle: 'Sorties et animations', gradient: 'gradient-accent', hasMap: true }
        };

        // Données d'exemple pour les annonces
        const sampleListings = [
            {
                id: 1, title: "MacBook Pro 13\" M2 - État neuf", description: "MacBook Pro 2023, 16GB RAM, 512GB SSD. Utilisé 3 mois, sous garantie Apple Care.",
                price: 1650, priceText: "1 650€", type: "vente", category: "tech", location: "Ganges", date: "2024-12-20",
                images: ["laptop1.jpg"], contact: "Marie L.", phone: "06.45.78.92.13"
            },
            {
                id: 2, title: "Cours de guitare à domicile", description: "Professeur expérimenté donne cours de guitare tous styles. Premier cours gratuit.",
                price: 0, priceText: "25€/h", type: "service", category: "loisirs", location: "Saint-Bauzille-de-Putois", date: "2024-12-19",
                images: [], contact: "Antoine M.", phone: "04.67.89.45.12"
            },
            {
                id: 3, title: "Surplus de légumes bio", description: "Courgettes, tomates, aubergines de mon potager. Récolte du jour, 100% bio.",
                price: 0, priceText: "Gratuit", type: "don", category: "maison", location: "Sumène", date: "2024-12-18",
                images: ["vegetables1.jpg"], contact: "Pierre D.", phone: "06.78.45.91.23"
            },
            {
                id: 4, title: "Vélo VTT Scott - Très bon état", description: "VTT Scott Aspect 950, taille L, révision récente, freins et dérailleur neufs.",
                price: 380, priceText: "380€", type: "vente", category: "loisirs", location: "Ganges", date: "2024-12-17",
                images: ["bike1.jpg"], contact: "Julien P.", phone: "07.89.45.67.12"
            },
            {
                id: 5, title: "Baby-sitting expérimentée", description: "Étudiante en psychologie propose baby-sitting. Références disponibles, véhiculée.",
                price: 0, priceText: "12€/h", type: "service", category: "enfants", location: "Saint-Hippolyte-du-Fort", date: "2024-12-16",
                images: [], contact: "Emma R.", phone: "06.45.78.32.19"
            },
            {
                id: 6, title: "Échange livre contre livre", description: "Romans, BD, essais. Propose échange 1 pour 1. Plus de 200 livres disponibles.",
                price: 0, priceText: "Échange", type: "troc", category: "loisirs", location: "Cazilhac", date: "2024-12-15",
                images: ["books1.jpg"], contact: "Claire B.", phone: "04.67.73.84.56"
            }
        ];

        // ==================== INITIALISATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initialisation Sud Cévennes Connect Ultra...');

            setTimeout(() => {
                initMap();
                initEventListeners();
                switchMode('nous');
                updatePopupListings();
            }, 500);
        });

        // ==================== CARTE ====================
        function initMap() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([43.9344, 3.6789], 11);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap © CARTO'
            }).addTo(map);
            L.control.zoom({ position: 'bottomleft' }).addTo(map);
            console.log('✅ Carte initialisée');
        }

        // ==================== ÉVÉNEMENTS ====================
        function initEventListeners() {
            document.getElementById('btn-nous').addEventListener('click', () => switchMode('nous'));
            document.getElementById('btn-echangeons').addEventListener('click', () => switchMode('echangeons'));
            document.getElementById('btn-moments').addEventListener('click', () => switchMode('moments'));

            document.getElementById('close-panel').addEventListener('click', closeSidePanel);
            document.getElementById('close-popup').addEventListener('click', closePopupEchangeons);
            document.getElementById('mobile-panel-btn').addEventListener('click', openSidePanel);

            // Événements des filtres popup
            document.querySelectorAll('#popup-echangeons .filter-tab').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Désactiver les autres dans le même groupe
                    const group = this.getAttribute('data-filter') || this.getAttribute('data-category') || this.getAttribute('data-price');
                    const groupName = this.hasAttribute('data-filter') ? 'data-filter' :
                                     this.hasAttribute('data-category') ? 'data-category' : 'data-price';

                    if (groupName === 'data-filter') {
                        document.querySelectorAll('[data-filter]').forEach(b => {
                            b.classList.remove('active', 'bg-orange-100', 'text-orange-800');
                            b.classList.add('bg-white', 'border', 'border-gray-200', 'text-gray-700');
                        });
                    }

                    // Activer le bouton cliqué
                    this.classList.remove('bg-white', 'border', 'border-gray-200', 'text-gray-700');
                    this.classList.add('active', 'bg-orange-100', 'text-orange-800');

                    // Filtrer les annonces
                    filterPopupListings();
                });
            });

            window.addEventListener('resize', handleResize);
        }

        // ==================== GESTION DES MODES INTELLIGENTS ====================
        function switchMode(mode) {
            if (currentMode === mode) {
                if (mode === 'echangeons') {
                    togglePopupEchangeons();
                } else {
                    toggleSidePanel();
                }
                return;
            }

            console.log(`✨ Mode: ${mode}`);
            currentMode = mode;

            updateButtonStates();
            compactHeader();

            if (mode === 'echangeons') {
                closeSidePanel();
                openPopupEchangeons();
            } else {
                closePopupEchangeons();
                updateSidePanel();
                updateMap();
                openSidePanel();
            }
        }

        function updateButtonStates() {
            document.querySelectorAll('.btn-smart').forEach(btn => {
                const btnMode = btn.id.replace('btn-', '');
                if (btnMode === currentMode) {
                    btn.classList.remove('inactive');
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                    btn.classList.add('inactive');
                }
            });
        }

        function compactHeader() {
            const header = document.getElementById('main-header');
            const logo = document.getElementById('logo-section');
            const container = document.getElementById('buttons-container');

            if (!isCompactMode) {
                isCompactMode = true;

                // Réduire le logo
                logo.style.transform = 'scale(0.7)';
                logo.style.marginBottom = '1rem';

                // Compacter le header
                header.style.padding = '1rem';
                container.classList.add('compact');

                // Masquer les textes et flèches sur les boutons inactifs
                document.querySelectorAll('.btn-smart.inactive').forEach(btn => {
                    btn.querySelector('.btn-text').style.display = 'none';
                    btn.querySelector('.btn-arrow').style.display = 'none';
                    btn.style.minWidth = 'auto';
                    btn.style.width = '80px';
                    btn.style.padding = '1rem';
                });

                // Garder le bouton actif normal
                const activeBtn = document.querySelector('.btn-smart.active');
                if (activeBtn) {
                    activeBtn.style.minWidth = '280px';
                    activeBtn.style.width = 'auto';
                    activeBtn.style.padding = '1.5rem 2.5rem';
                }
            }
        }

        // ==================== POPUP ÉCHANGEONS ====================
        function openPopupEchangeons() {
            const popup = document.getElementById('popup-echangeons');
            const content = popup.querySelector('.popup-content');

            popup.classList.remove('hidden');
            setTimeout(() => {
                content.classList.add('open');
            }, 10);
        }

        function closePopupEchangeons() {
            const popup = document.getElementById('popup-echangeons');
            const content = popup.querySelector('.popup-content');

            content.classList.remove('open');
            setTimeout(() => {
                popup.classList.add('hidden');
            }, 500);
        }

        function togglePopupEchangeons() {
            const popup = document.getElementById('popup-echangeons');
            if (popup.classList.contains('hidden')) {
                openPopupEchangeons();
            } else {
                closePopupEchangeons();
            }
        }

        function updatePopupListings() {
            const container = document.getElementById('popup-listings-content');
            const html = sampleListings.map(listing => `
                <div class="card-modern p-6 rounded-2xl hover:shadow-xl transition-all duration-300 cursor-pointer">
                    <div class="flex gap-4">
                        <div class="w-20 h-20 bg-gradient-to-br from-gray-100 to-gray-200 rounded-xl flex items-center justify-center text-2xl">
                            ${getListingIcon(listing.category)}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between mb-2">
                                <h3 class="font-bold text-lg text-gray-900 line-clamp-1">${listing.title}</h3>
                                <div class="text-right ml-4">
                                    <div class="font-bold text-xl text-orange-600">${listing.priceText}</div>
                                    <span class="text-xs px-2 py-1 rounded-full ${getTypeColor(listing.type)} capitalize">${listing.type}</span>
                                </div>
                            </div>
                            <p class="text-gray-600 text-sm mb-3 line-clamp-2">${listing.description}</p>
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-4 text-gray-500">
                                    <div class="flex items-center gap-1">
                                        <i class="fas fa-map-marker-alt text-orange-500"></i>
                                        <span>${listing.location}</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <i class="fas fa-user text-gray-400"></i>
                                        <span>${listing.contact}</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <i class="fas fa-clock text-gray-400"></i>
                                        <span>${formatDateShort(listing.date)}</span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="px-3 py-1 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                                        <i class="fas fa-phone mr-1"></i>Contacter
                                    </button>
                                    <button class="px-3 py-1 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
            document.getElementById('popup-results-count').textContent = sampleListings.length;
        }

        function filterPopupListings() {
            // Logique de filtrage (simplifiée pour la démo)
            updatePopupListings();
        }

        // ==================== PANNEAU LATÉRAL (NOUS/MOMENTS) ====================
        function updateSidePanel() {
            const config = modeConfig[currentMode];
            const header = document.getElementById('panel-header');
            header.className = `${config.gradient} text-white p-8 relative overflow-hidden`;

            document.getElementById('panel-title').textContent = config.title;
            document.getElementById('panel-subtitle').textContent = config.subtitle;

            updateSecondaryFilters();
            updatePanelContent();
        }

        function updateSecondaryFilters() {
            const container = document.getElementById('filter-buttons');
            container.innerHTML = '';

            let filters = [];
            if (currentMode === 'nous') {
                filters = [
                    { key: 'all', label: 'Tous', emoji: '🏷️' },
                    { key: 'restaurant', label: 'Restaurants', emoji: '🍽️' },
                    { key: 'sante', label: 'Santé', emoji: '🏥' },
                    { key: 'artisan', label: 'Artisans', emoji: '🔧' }
                ];
            }

            filters.forEach(filter => {
                const isActive = filter.key === currentFilter;
                const btn = document.createElement('button');
                btn.className = `px-4 py-2 rounded-xl font-semibold text-sm transition-all duration-300 hover:scale-105 ${isActive ? 'bg-gray-900 text-white shadow-lg' : 'bg-white text-gray-700 border border-gray-200 hover:shadow-md'}`;
                btn.innerHTML = `<span class="mr-2">${filter.emoji}</span>${filter.label}`;
                btn.addEventListener('click', () => filterContent(filter.key));
                container.appendChild(btn);
            });
        }

        function filterContent(filterKey) {
            currentFilter = filterKey;
            updateSecondaryFilters();
            updatePanelContent();
            updateMap();
        }

        function updatePanelContent() {
            const container = document.getElementById('panel-content');

            if (currentMode === 'nous') {
                updateBusinessContent(container);
            } else if (currentMode === 'moments') {
                updateEventsContent(container);
            }
        }

        function updateBusinessContent(container) {
            if (typeof businesses === 'undefined') {
                container.innerHTML = '<div class="p-8 text-center text-gray-500">Données non disponibles</div>';
                return;
            }

            let filtered = businesses;
            if (currentFilter !== 'all') {
                filtered = businesses.filter(b => b.category === currentFilter);
            }

            document.getElementById('results-count').textContent = filtered.length;

            const html = filtered.map(business => `
                <div class="card-modern m-6 p-6 rounded-2xl cursor-pointer group" onclick="focusOnLocation(${business.lat}, ${business.lng})">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, ${modernColors[business.category]}40, ${modernColors[business.category]}20);">
                            ${getCategoryIcon(business.category)}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-lg text-gray-900 group-hover:text-green-600 transition-colors mb-2">${business.name}</h3>
                            <p class="text-gray-600 text-sm mb-3 line-clamp-2">${business.description}</p>
                            <div class="space-y-2 text-sm text-gray-500">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-map-marker-alt text-green-500 w-4"></i>
                                    <span class="truncate">${business.address}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-phone text-blue-500 w-4"></i>
                                    <a href="tel:${business.phone}" class="text-blue-600 hover:text-blue-700 font-medium">${business.phone}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html || '<div class="p-8 text-center text-gray-500">Aucun résultat</div>';
        }

        function updateEventsContent(container) {
            if (typeof events === 'undefined') {
                container.innerHTML = '<div class="p-8 text-center text-gray-500">Données non disponibles</div>';
                return;
            }

            let filtered = events;
            if (currentFilter !== 'all') {
                filtered = events.filter(e => e.category === currentFilter);
            }

            document.getElementById('results-count').textContent = filtered.length;

            const html = filtered.map(event => `
                <div class="card-modern m-6 p-6 rounded-2xl cursor-pointer group">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl" style="background: linear-gradient(135deg, ${modernColors[event.category]}40, ${modernColors[event.category]}20);">
                            ${getEventIcon(event.category)}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-lg text-gray-900 group-hover:text-purple-600 transition-colors mb-2">${event.title}</h3>
                            <p class="text-gray-600 text-sm mb-3 line-clamp-2">${event.description}</p>
                            <div class="space-y-2 text-sm text-gray-500">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-calendar text-purple-500 w-4"></i>
                                    <span>${formatDate(event.date)} • ${event.time}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-map-marker-alt text-purple-500 w-4"></i>
                                    <span class="truncate">${event.location}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html || '<div class="p-8 text-center text-gray-500">Aucun résultat</div>';
        }

        // ==================== CARTE ET MARKERS ====================
        function updateMap() {
            currentMarkers.forEach(marker => map.removeLayer(marker));
            currentMarkers = [];

            if (currentMode === 'nous') {
                updateBusinessMarkers();
            } else if (currentMode === 'moments') {
                updateEventMarkers();
            }
        }

        function updateBusinessMarkers() {
            if (typeof businesses === 'undefined') return;

            let filtered = businesses;
            if (currentFilter !== 'all') {
                filtered = businesses.filter(b => b.category === currentFilter);
            }

            filtered.forEach(business => {
                const marker = L.marker([business.lat, business.lng], {
                    icon: createModernIcon(business.category, getCategoryIcon(business.category))
                }).addTo(map);

                marker.bindPopup(`
                    <div class="p-4 min-w-[300px] font-sans">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center text-xl" style="background: linear-gradient(135deg, ${modernColors[business.category]}40, ${modernColors[business.category]}20);">
                                ${getCategoryIcon(business.category)}
                            </div>
                            <h3 class="font-bold text-lg text-gray-900">${business.name}</h3>
                        </div>
                        <p class="text-gray-600 text-sm mb-3">${business.description.substring(0, 100)}...</p>
                        <div class="text-sm space-y-1">
                            <div><i class="fas fa-map-marker-alt mr-2 text-green-500"></i>${business.address}</div>
                            <div><i class="fas fa-phone mr-2 text-blue-500"></i><a href="tel:${business.phone}" class="text-blue-600">${business.phone}</a></div>
                        </div>
                    </div>
                `);

                currentMarkers.push(marker);
            });
        }

        function updateEventMarkers() {
            if (typeof events === 'undefined') return;

            events.forEach(event => {
                const lat = event.lat || 43.9344 + (Math.random() - 0.5) * 0.1;
                const lng = event.lng || 3.6789 + (Math.random() - 0.5) * 0.1;

                const marker = L.marker([lat, lng], {
                    icon: createModernIcon('event', getEventIcon(event.category))
                }).addTo(map);

                currentMarkers.push(marker);
            });
        }

        // ==================== PANNEAU LATERAL MOBILE ====================
        function openSidePanel() {
            document.getElementById('side-panel').style.transform = 'translateX(0)';
            if (window.innerWidth <= 1024) {
                document.getElementById('mobile-panel-btn').style.display = 'none';
            }
        }

        function closeSidePanel() {
            document.getElementById('side-panel').style.transform = 'translateX(100%)';
            if (window.innerWidth <= 1024) {
                document.getElementById('mobile-panel-btn').style.display = 'flex';
            }
        }

        function toggleSidePanel() {
            const panel = document.getElementById('side-panel');
            if (panel.style.transform === 'translateX(0px)') {
                closeSidePanel();
            } else {
                openSidePanel();
            }
        }

        function handleResize() {
            if (window.innerWidth > 1024) {
                document.getElementById('mobile-panel-btn').style.display = 'none';
            }
        }

        // ==================== UTILITAIRES ====================
        function createModernIcon(category, emoji) {
            const color = modernColors[category] || modernColors.default;
            return L.divIcon({
                html: `
                    <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl font-bold text-white shadow-2xl transform hover:scale-110 transition-transform duration-200" style="background: linear-gradient(135deg, ${color}, ${color}dd); border: 3px solid white;">
                        ${emoji}
                    </div>
                `,
                className: 'custom-modern-marker',
                iconSize: [48, 48],
                iconAnchor: [24, 24]
            });
        }

        function getCategoryIcon(category) {
            const icons = {
                restaurant: '🍽️', sante: '🏥', artisan: '🔧', commerce: '🛒',
                hebergement: '🏨', service_pro: '🎓', bienetre: '🌿'
            };
            return icons[category] || '📍';
        }

        function getEventIcon(category) {
            const icons = {
                culture: '🎭', sport: '⚽', famille: '👨‍👩‍👧‍👦', nature: '🌲',
                marche: '🛒', gastronomie: '🍷'
            };
            return icons[category] || '📅';
        }

        function getListingIcon(category) {
            const icons = {
                tech: '💻', maison: '🏠', vehicules: '🚗', mode: '👕',
                loisirs: '🎮', enfants: '🍼'
            };
            return icons[category] || '📦';
        }

        function getTypeColor(type) {
            const colors = {
                vente: 'bg-green-100 text-green-800',
                don: 'bg-blue-100 text-blue-800',
                troc: 'bg-purple-100 text-purple-800',
                recherche: 'bg-orange-100 text-orange-800',
                service: 'bg-indigo-100 text-indigo-800'
            };
            return colors[type] || 'bg-gray-100 text-gray-800';
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR', {
                weekday: 'short', day: 'numeric', month: 'short'
            });
        }

        function formatDateShort(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR', {
                day: 'numeric', month: 'short'
            });
        }

        function focusOnLocation(lat, lng) {
            map.setView([lat, lng], 16);
            if (window.innerWidth <= 1024) {
                setTimeout(() => closeSidePanel(), 500);
            }
        }
    </script>
</body>
</html>