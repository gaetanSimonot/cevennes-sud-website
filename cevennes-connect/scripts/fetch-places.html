<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extraction Google Places - C√©vennes Sud</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #00ff00;
            text-align: center;
        }
        .status {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
        }
        .log {
            margin: 5px 0;
            padding: 5px;
        }
        .log.success { color: #00ff00; }
        .log.error { color: #ff0000; }
        .log.warning { color: #ffaa00; }
        .log.info { color: #00aaff; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            margin: 10px 5px;
        }
        button:hover {
            background: #00cc00;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .summary {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .summary h2 {
            color: #00ff00;
            margin-top: 0;
        }
        .category-count {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: #1e1e1e;
            border-radius: 4px;
        }
        .download-section {
            text-align: center;
            margin: 30px 0;
        }
        #downloadBtn {
            background: #ff00ff;
            font-size: 18px;
            padding: 20px 40px;
        }
        #downloadBtn:hover {
            background: #cc00cc;
        }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è Extraction Google Places API - C√©vennes Sud</h1>

    <div style="text-align: center;">
        <button id="startBtn" onclick="startFetch()">üöÄ Lancer l'extraction</button>
        <button id="stopBtn" onclick="stopFetch()" disabled>‚èπÔ∏è Arr√™ter</button>
    </div>

    <div class="status" id="logs">
        <div class="log info">üìç Centre: Ganges (43.9339, 3.7086)</div>
        <div class="log info">üìè Rayon: 5km</div>
        <div class="log info">‚è±Ô∏è  Pr√™t √† d√©marrer...</div>
    </div>

    <div class="summary" id="summary" style="display: none;">
        <h2>üìä R√©sum√© de l'extraction</h2>
        <div id="summaryContent"></div>
    </div>

    <div class="download-section" id="downloadSection" style="display: none;">
        <button id="downloadBtn" onclick="downloadJSON()">üíæ T√©l√©charger actors-data.json</button>
    </div>

    <script>
        const API_KEY = 'AIzaSyBe9S2a8Afc67NtS9UmvEwOoLt3BFne0eI';
        const CENTER = { lat: 43.9339, lng: 3.7086 };
        const RADIUS = 5000;

        const CATEGORIES_MAP = {
            commerce: ['store', 'supermarket', 'convenience_store', 'grocery_or_supermarket', 'shopping_mall'],
            restaurant: ['restaurant', 'cafe', 'bakery', 'meal_takeaway', 'food'],
            artisan: ['plumber', 'electrician', 'locksmith', 'roofing_contractor', 'hardware_store'],
            therapeute: ['physiotherapist', 'spa', 'beauty_salon', 'hair_care', 'dentist', 'doctor'],
            service: ['car_repair', 'car_dealer', 'gas_station', 'bank', 'post_office', 'laundry'],
            association: ['community_center', 'local_government_office', 'library']
        };

        let allActors = {};
        let isRunning = false;

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.textContent = message;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        function createActorData(place, category) {
            const photo = place.photos && place.photos[0]
                ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photo_reference=${place.photos[0].photo_reference}&key=${API_KEY}`
                : 'https://images.unsplash.com/photo-1441986300917-64674bd600d8?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';

            return {
                id: place.place_id,
                name: place.name,
                category: category,
                description: place.types ? place.types.slice(0, 3).join(', ') : 'Commerce local',
                address: place.vicinity || place.formatted_address || '',
                phone: place.formatted_phone_number || 'Non renseign√©',
                email: '',
                website: place.website || '',
                horaires: place.opening_hours?.weekday_text?.join(', ') || 'Horaires non renseign√©s',
                specialites: place.types?.slice(0, 5) || [],
                lat: place.geometry.location.lat,
                lng: place.geometry.location.lng,
                image: photo,
                rating: place.rating || 0,
                reviews_count: place.user_ratings_total || 0
            };
        }

        async function searchPlaces(type) {
            const url = `https://cors-anywhere.herokuapp.com/https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=${CENTER.lat},${CENTER.lng}&radius=${RADIUS}&type=${type}&key=${API_KEY}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.status === 'OK') {
                    return data.results;
                } else {
                    log(`‚ö†Ô∏è  Erreur API pour ${type}: ${data.status}`, 'warning');
                    return [];
                }
            } catch (error) {
                log(`‚ùå Erreur pour ${type}: ${error.message}`, 'error');
                return [];
            }
        }

        async function getPlaceDetails(placeId) {
            const url = `https://cors-anywhere.herokuapp.com/https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=name,formatted_address,formatted_phone_number,website,opening_hours,geometry,types,photos,rating,user_ratings_total&key=${API_KEY}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.status === 'OK') {
                    return data.result;
                }
                return null;
            } catch (error) {
                return null;
            }
        }

        async function startFetch() {
            if (isRunning) return;

            isRunning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('summary').style.display = 'none';
            document.getElementById('downloadSection').style.display = 'none';

            allActors = {
                commerce: [],
                restaurant: [],
                artisan: [],
                therapeute: [],
                service: [],
                association: []
            };

            log('üîç D√©but de l\'extraction...', 'info');
            log('‚ö†Ô∏è  NOTE: Vous devez d\'abord activer CORS sur https://cors-anywhere.herokuapp.com/', 'warning');

            for (const [category, types] of Object.entries(CATEGORIES_MAP)) {
                if (!isRunning) break;

                log(`\nüìç Cat√©gorie: ${category.toUpperCase()}`, 'info');
                const placesSet = new Set();

                for (const type of types) {
                    if (!isRunning) break;

                    log(`  Recherche: ${type}...`, 'info');
                    const places = await searchPlaces(type);
                    await new Promise(r => setTimeout(r, 500));

                    for (const place of places) {
                        if (!isRunning) break;

                        if (!placesSet.has(place.place_id)) {
                            placesSet.add(place.place_id);
                            const details = await getPlaceDetails(place.place_id);
                            await new Promise(r => setTimeout(r, 500));

                            if (details) {
                                const actorData = createActorData(details, category);
                                allActors[category].push(actorData);
                                log(`    ‚úì ${details.name}`, 'success');
                            }
                        }
                    }
                }

                log(`  Total ${category}: ${allActors[category].length} commerces`, 'success');
            }

            if (isRunning) {
                showSummary();
                log('\n‚úÖ Extraction termin√©e !', 'success');
                document.getElementById('downloadSection').style.display = 'block';
            }

            isRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function stopFetch() {
            isRunning = false;
            log('\n‚èπÔ∏è  Extraction arr√™t√©e', 'warning');
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function showSummary() {
            const summaryDiv = document.getElementById('summaryContent');
            const total = Object.values(allActors).flat().length;

            let html = '<div style="margin-bottom: 20px; font-size: 18px; font-weight: bold;">Total: ' + total + ' commerces</div>';

            for (const [category, items] of Object.entries(allActors)) {
                html += `<div class="category-count">
                    <span>${category}</span>
                    <span style="color: #00ff00; font-weight: bold;">${items.length} commerces</span>
                </div>`;
            }

            summaryDiv.innerHTML = html;
            document.getElementById('summary').style.display = 'block';
        }

        function downloadJSON() {
            const dataStr = JSON.stringify(allActors, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportFileDefaultName = 'actors-data.json';

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            log('\nüíæ Fichier t√©l√©charg√© : actors-data.json', 'success');
        }
    </script>
</body>
</html>
