<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artefact IA - √âv√©nements - C√©vennes Sud</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Configuration -->
    <script src="js/config.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }
        .drop-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 16px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8fafc;
            cursor: pointer;
        }
        .drop-zone.drag-over {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: scale(1.02);
        }
        .drop-zone:hover {
            border-color: #94a3b8;
            background: #f1f5f9;
        }
        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 12px;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .log-console {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 12px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
        }
        .log-success { color: #00ff00; }
        .log-error { color: #ff0000; }
        .log-warning { color: #ffaa00; }
        .log-info { color: #00aaff; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-bold text-gray-900 mb-2 text-center">
            <i class="fas fa-magic text-pink-600 mr-3"></i>
            Artefact IA - Extraction d'√âv√©nements
        </h1>
        <p class="text-center text-gray-600 mb-8">Glissez un screenshot, collez du texte ou un lien - L'IA extrait et reformule automatiquement !</p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Zone de Drop -->
            <div>
                <h2 class="text-2xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-upload text-blue-600 mr-2"></i>
                    Sources d'Information
                </h2>

                <!-- Drop Zone Images -->
                <div id="dropZone" class="drop-zone mb-6">
                    <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Glissez une image ici</h3>
                    <p class="text-gray-500 mb-4">ou cliquez pour s√©lectionner</p>
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                    <button onclick="document.getElementById('fileInput').click()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition">
                        <i class="fas fa-folder-open mr-2"></i>Parcourir
                    </button>
                </div>

                <!-- Images Preview -->
                <div id="imagesPreview" class="hidden mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Images ajout√©es:</h3>
                    <div id="imagesList" class="flex flex-wrap gap-4"></div>
                </div>

                <!-- Text Area -->
                <div class="mb-6">
                    <label class="block text-lg font-semibold text-gray-700 mb-2">
                        <i class="fas fa-align-left text-green-600 mr-2"></i>
                        Texte ou Lien
                    </label>
                    <textarea id="textInput" rows="8" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Collez ici le texte de l'√©v√©nement, une URL Facebook, un lien vers une affiche..."></textarea>
                </div>

                <!-- Bouton Analyser -->
                <button id="analyzeBtn" onclick="analyzeEvent()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-xl font-semibold text-lg hover:shadow-xl transition-all">
                    <i class="fas fa-brain mr-2"></i>Analyser avec l'IA
                </button>
            </div>

            <!-- Zone de R√©sultat -->
            <div>
                <h2 class="text-2xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-robot text-purple-600 mr-2"></i>
                    Traitement IA
                </h2>

                <!-- Console de Log -->
                <div class="log-console mb-6" id="console">
                    <div class="log-info">ü§ñ Pr√™t √† analyser vos √©v√©nements avec OpenAI GPT-4 Vision</div>
                    <div class="log-info">üì∏ Vous pouvez ajouter des images d'affiches</div>
                    <div class="log-info">üìù Ou coller du texte / liens</div>
                    <div class="log-warning">‚ö†Ô∏è  L'analyse peut prendre 10-30 secondes</div>
                </div>

                <!-- R√©sultat JSON -->
                <div id="resultSection" class="hidden">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-code text-green-600 mr-2"></i>
                        √âv√©nement G√©n√©r√©
                    </h3>
                    <div class="bg-gray-900 text-green-400 p-6 rounded-xl overflow-x-auto mb-4" style="max-height: 400px;">
                        <pre id="jsonOutput" class="text-sm"></pre>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="copyJSON()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-700 transition-all">
                            <i class="fas fa-copy mr-2"></i>Copier JSON
                        </button>
                        <button onclick="downloadJSON()" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-green-700 transition-all">
                            <i class="fas fa-download mr-2"></i>T√©l√©charger
                        </button>
                        <button onclick="commitToGitHub()" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-xl transition-all">
                            <i class="fab fa-github mr-2"></i>Commit GitHub
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8 text-center">
            <a href="evenements.html" class="inline-block bg-gray-200 text-gray-700 px-8 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-all">
                <i class="fas fa-arrow-left mr-2"></i>Retour aux √âv√©nements
            </a>
        </div>
    </div>

    <script>
        // Plus besoin de la cl√© OpenAI ici, elle est s√©curis√©e c√¥t√© serveur !
        let uploadedImages = [];
        let generatedEvent = null;

        // Drag & Drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedImages.push({
                            data: e.target.result,
                            name: file.name
                        });
                        displayImages();
                        log(`‚úì Image ajout√©e: ${file.name}`, 'success');
                    };
                    reader.readAsDataURL(file);
                } else {
                    log(`‚úó Fichier non support√©: ${file.name}`, 'error');
                }
            });
        }

        function displayImages() {
            const preview = document.getElementById('imagesPreview');
            const imagesList = document.getElementById('imagesList');

            preview.classList.remove('hidden');
            imagesList.innerHTML = uploadedImages.map((img, index) => `
                <div class="relative">
                    <img src="${img.data}" class="preview-image" alt="${img.name}">
                    <button onclick="removeImage(${index})" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-8 h-8 hover:bg-red-600 transition">
                        <i class="fas fa-times"></i>
                    </button>
                    <p class="text-xs text-gray-600 mt-2 text-center">${img.name}</p>
                </div>
            `).join('');
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            displayImages();
            if (uploadedImages.length === 0) {
                document.getElementById('imagesPreview').classList.add('hidden');
            }
            log(`‚úì Image supprim√©e`, 'info');
        }

        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = message;
            console.appendChild(entry);
            console.scrollTop = console.scrollHeight;
        }

        async function analyzeEvent() {
            let textInput = document.getElementById('textInput').value;
            const analyzeBtn = document.getElementById('analyzeBtn');

            if (uploadedImages.length === 0 && !textInput.trim()) {
                log('‚ùå Veuillez ajouter une image ou du texte', 'error');
                alert('Veuillez ajouter au moins une image ou du texte');
                return;
            }

            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyse en cours...';
            log('\nüöÄ D√©marrage de l\'analyse avec OpenAI GPT-4 Vision...', 'info');

            // D√©tecter si le texte contient une URL
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const urls = textInput.match(urlRegex);

            if (urls && urls.length > 0) {
                log('üîó URL d√©tect√©e, r√©cup√©ration du contenu...', 'info');
                try {
                    // Utiliser un service CORS proxy pour r√©cup√©rer le contenu
                    const url = urls[0];
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    const data = await response.json();

                    if (data.contents) {
                        // Extraire le texte du HTML
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(data.contents, 'text/html');
                        const pageText = doc.body.innerText || doc.body.textContent;

                        // Limiter √† 3000 caract√®res pour ne pas d√©passer les limites
                        textInput = pageText.substring(0, 3000);
                        log(`‚úì Contenu r√©cup√©r√© (${pageText.length} caract√®res)`, 'success');
                    }
                } catch (error) {
                    log('‚ö† Impossible de r√©cup√©rer le contenu de l\'URL, utilisation du texte fourni', 'info');
                }
            }

            try {
                // Pr√©parer le prompt
                const prompt = `Tu es un assistant sp√©cialis√© dans l'extraction d'informations d'√©v√©nements depuis des copier-coller brouillons, des images ou du texte mal format√©.

**TA MISSION : √äTRE ROBUSTE ET EFFICACE**

Tu vas recevoir des donn√©es parfois sales (copier-coller, caract√®res bizarres, formatage cass√©, infos m√©lang√©es). Ton job est d'isoler SEULEMENT les infos essentielles et cr√©er des √©v√©nements valides.

**R√àGLES STRICTES** :

1. **GESTION DES COPIER-COLLER SALES** :
   - Ignore les caract√®res sp√©ciaux bizarres (emojis cass√©s, unicode √©trange, etc.)
   - Nettoie les espaces multiples, sauts de ligne inutiles
   - Extrait SEULEMENT les infos utiles, ignore le bruit
   - Si le texte est incompr√©hensible, fais de ton mieux avec ce qui est lisible
   - FORMAT SP√âCIAL : Si tu vois "Ville (Code postal)" √† la fin ‚Üí c'est l'adresse compl√®te
   - Exemple : "Valflaun√®s (34270)" ‚Üí address: "34270 Valflaun√®s"

2. **CARACT√àRES DANGEREUX POUR JSON** :
   - √âchappe TOUJOURS les guillemets doubles dans les textes
   - Remplace les guillemets typographiques par des guillemets simples (')
   - Retire les retours chariots dans les textes (une seule ligne)
   - Supprime les backslashes orphelins
   - Pas de caract√®res de contr√¥le (TAB, NULL, etc.)

3. **UNE IMAGE = UN SEUL √âV√âNEMENT** : M√™me si l'affiche mentionne plusieurs dates, c'est UN √©v√©nement

4. **PRIORIT√â AUX INFOS MINIMALES** :
   - **OBLIGATOIRE** : title + date + ville (dans address ou location)
   - **IMPORTANT** : time, category
   - **OPTIONNEL** : tout le reste
   - Si tu n'es pas s√ªr d'une info ‚Üí laisse vide "" plut√¥t que de risquer une erreur

5. **EN CAS DE DOUTE** :
   - Date floue ? ‚Üí Mets la premi√®re date mentionn√©e ou laisse vide
   - Heure floue ? ‚Üí Mets "14:00" par d√©faut ou laisse vide
   - Lieu vague ? ‚Üí Mets au moins le nom de la ville dans address
   - Prix inconnu ? ‚Üí Mets "Non renseign√©"

6. **VILLE OBLIGATOIRE** : L'adresse DOIT contenir une ville des C√©vennes (Le Vigan, Ganges, Saint-Hippolyte-du-Fort, Sum√®ne, Valleraugue, etc.). Sans ville, pas de carte !

Pour chaque √©v√©nement, extrais :

- **title** (OBLIGATOIRE) : Titre de l'√©v√©nement
- **category** : "festival", "marche", "culture", "sport", "atelier"
- **description** : 1-2 phrases MAX, propres, sans caract√®res bizarres
- **date** : YYYY-MM-DD (OBLIGATOIRE)
- **time** : HH:MM (24h)
- **location** : Nom du lieu
- **address** : Ville + code postal minimum (ex: "30120 Le Vigan")
- **price** : Ex: "Gratuit", "10‚Ç¨"
- **organizer** : Nom de l'organisateur
- **contact** : Email ou tel
- **website** : URL compl√®te

${textInput ? `\n**Donn√©es brutes fournies :**\n${textInput}` : ''}

**IMPORTANT** :
- Retourne UNIQUEMENT du JSON valide, propre, sans texte avant/apr√®s
- Chaque string doit √™tre √©chapp√©e correctement
- Pas d'images base64, toujours "image": ""
- Si aucun √©v√©nement valide d√©tect√© ‚Üí retourne []

Format attendu :
[
  {
    "title": "March√© de Valflaun√®s",
    "category": "marche",
    "description": "March√© artisanal local tous les dimanches matin",
    "date": "2025-10-12",
    "time": "09:00",
    "location": "Place Gabriel Calmels",
    "address": "34270 Valflaun√®s",
    "price": "Gratuit",
    "organizer": "",
    "contact": "",
    "website": "",
    "image": ""
  }
]

**EXEMPLE de parsing :**
Texte: "MARCH√â DE VALFLAUN√àSMarch√© artisanal 12 Oct. [...] tous les dimanches matin sur la place Gabriel Calmels. [...] Valflaun√®s (34270)"
‚Üí title: "March√© de Valflaun√®s"
‚Üí category: "marche"
‚Üí date: "2025-10-12" (Oct = 10)
‚Üí time: "09:00" (matins = 09:00 par d√©faut)
‚Üí location: "Place Gabriel Calmels"
‚Üí address: "34270 Valflaun√®s" (extrait de la fin)
‚Üí price: "Gratuit" (march√©s = gratuit en g√©n√©ral)`;

                // Pr√©parer les messages pour l'API
                const messages = [
                    {
                        role: 'user',
                        content: [
                            { type: 'text', text: prompt }
                        ]
                    }
                ];

                // Ajouter les images si pr√©sentes
                if (uploadedImages.length > 0) {
                    log(`üì∏ Envoi de ${uploadedImages.length} image(s) √† OpenAI...`, 'info');
                    uploadedImages.forEach(img => {
                        messages[0].content.push({
                            type: 'image_url',
                            image_url: { url: img.data }
                        });
                    });
                }

                // D√©tecter si on est en local ou en production
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';

                let response;

                if (isLocal) {
                    // En local : appeler directement OpenAI (n√©cessite OPENAI_API_KEY dans config.js)
                    log('‚è≥ Mode LOCAL : Appel direct √† OpenAI API...', 'info');

                    if (!CONFIG.OPENAI_API_KEY) {
                        throw new Error('OPENAI_API_KEY manquante dans config.js pour le mode local');
                    }

                    response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o',
                            messages: messages,
                            max_tokens: 4000,
                            temperature: 0.7
                        })
                    });
                } else {
                    // En production : utiliser notre API serverless s√©curis√©e
                    log('‚è≥ Mode PRODUCTION : Appel via API s√©curis√©e...', 'info');
                    response = await fetch('/api/openai', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o',
                            messages: messages,
                            max_tokens: 4000,
                            temperature: 0.7
                        })
                    });
                }

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Erreur API OpenAI');
                }

                const data = await response.json();
                log('‚úÖ R√©ponse re√ßue de OpenAI', 'success');

                // Extraire le JSON de la r√©ponse
                let jsonText = data.choices[0].message.content.trim();

                // Nettoyer le texte (enlever les balises markdown si pr√©sentes)
                jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

                let eventsArray = JSON.parse(jsonText);

                // S'assurer que c'est un tableau
                if (!Array.isArray(eventsArray)) {
                    eventsArray = [eventsArray];
                }

                // V√©rifier qu'il y a au moins un √©v√©nement
                if (eventsArray.length === 0) {
                    log('‚ö†Ô∏è Aucun √©v√©nement valide d√©tect√© dans les donn√©es fournies.', 'warning');
                    log('üí° Conseil : V√©rifiez que votre texte contient au minimum un titre, une date et un lieu.', 'info');
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = originalBtnText;
                    return;
                }

                log(`‚úÖ ${eventsArray.length} √©v√©nement(s) d√©tect√©(s) !`, 'success');

                // G√©ocoder les adresses pour obtenir les coordonn√©es
                log('üó∫Ô∏è G√©ocodage des adresses en cours...', 'info');

                const geocodePromises = eventsArray.map(async (eventData, index) => {
                    // Ajouter l'ID unique
                    eventData.id = Date.now() + index;

                    // NE PAS inclure les images base64 - utiliser des URLs
                    eventData.image = 'https://images.unsplash.com/photo-1492684223066-81342ee5ff30?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';

                    // D√©finir le niveau premium par d√©faut
                    eventData.premium_level = 'standard';

                    // G√©ocoder l'adresse si elle existe
                    if (eventData.address && eventData.address.trim() !== '') {
                        try {
                            // Ajouter "France, C√©vennes" pour aider la recherche
                            const searchAddress = `${eventData.address}, C√©vennes, France`;

                            // Utiliser l'API serverless pour le g√©ocodage
                            const geoResponse = await fetch('/api/geocode', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ address: searchAddress })
                            });
                            const geoData = await geoResponse.json();

                            if (geoData.results && geoData.results.length > 0) {
                                eventData.lat = geoData.results[0].geometry.location.lat;
                                eventData.lng = geoData.results[0].geometry.location.lng;
                                const foundLocation = geoData.results[0].formatted_address;
                                log(`‚úì ${eventData.title}`, 'success');
                                log(`  ‚Üí ${foundLocation}`, 'info');
                                log(`  ‚Üí Coordonn√©es : ${eventData.lat.toFixed(4)}, ${eventData.lng.toFixed(4)}`, 'success');
                            } else {
                                // Coordonn√©es par d√©faut (Ganges)
                                eventData.lat = 43.9339;
                                eventData.lng = 3.7086;
                                log(`‚ö† ${eventData.title} : adresse "${eventData.address}" non trouv√©e`, 'info');
                                log(`  ‚Üí Utilisation coordonn√©es Ganges par d√©faut`, 'info');
                            }
                        } catch (error) {
                            // Coordonn√©es par d√©faut en cas d'erreur
                            eventData.lat = 43.9339;
                            eventData.lng = 3.7086;
                            log(`‚ö† ${eventData.title} : erreur g√©ocodage`, 'info');
                        }
                    } else {
                        // Pas d'adresse : coordonn√©es par d√©faut (Ganges)
                        eventData.lat = 43.9339;
                        eventData.lng = 3.7086;
                        log(`‚ö† ${eventData.title} : aucune adresse fournie`, 'info');
                    }
                });

                await Promise.all(geocodePromises);

                generatedEvent = eventsArray;

                // Afficher le r√©sultat
                document.getElementById('jsonOutput').textContent = JSON.stringify(eventsArray, null, 2);
                document.getElementById('resultSection').classList.remove('hidden');
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });

                log('‚úÖ √âv√©nements g√©n√©r√©s avec succ√®s !', 'success');

            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                console.error('Erreur compl√®te:', error);
                alert(`Erreur lors de l'analyse: ${error.message}`);
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-brain mr-2"></i>Analyser avec l\'IA';
            }
        }

        function copyJSON() {
            const jsonText = document.getElementById('jsonOutput').textContent;
            navigator.clipboard.writeText(jsonText).then(() => {
                alert('‚úÖ JSON copi√© dans le presse-papier !');
            });
        }

        function downloadJSON() {
            if (!generatedEvent) return;

            const isMultiple = Array.isArray(generatedEvent) && generatedEvent.length > 1;
            const dataStr = JSON.stringify(generatedEvent, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportFileDefaultName = isMultiple
                ? `events-batch-${Date.now()}.json`
                : `event-${generatedEvent[0]?.id || Date.now()}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            log('‚úÖ Fichier JSON t√©l√©charg√© !', 'success');

            const count = Array.isArray(generatedEvent) ? generatedEvent.length : 1;
            alert(`‚úÖ Fichier t√©l√©charg√©: ${exportFileDefaultName}\n\nüìä ${count} √©v√©nement(s) g√©n√©r√©(s)\n\nüìù PROCHAINE √âTAPE:\n1. Va dans le dossier data/\n2. Ouvre events-data.json\n3. Ajoute ${count > 1 ? 'ces √©v√©nements' : 'cet √©v√©nement'} dans le tableau JSON\n4. Commit sur GitHub`);
        }

        async function commitToGitHub() {
            if (!generatedEvent) {
                alert('‚ùå Aucun √©v√©nement √† committer !');
                return;
            }

            const count = Array.isArray(generatedEvent) ? generatedEvent.length : 1;
            const events = Array.isArray(generatedEvent) ? generatedEvent : [generatedEvent];

            if (!confirm(`√ätes-vous s√ªr de vouloir committer ${count} √©v√©nement(s) sur GitHub ?\n\nCela va FUSIONNER les nouveaux √©v√©nements avec ceux existants dans events-data.json`)) {
                return;
            }

            log('üì§ Chargement des √©v√©nements existants...', 'info');

            try {
                // √âtape 1 : Charger les √©v√©nements existants
                let existingEvents = [];
                try {
                    const response = await fetch('/data/events-data.json');
                    if (response.ok) {
                        existingEvents = await response.json();
                        log(`‚úì ${existingEvents.length} √©v√©nements existants charg√©s`, 'success');
                    }
                } catch (error) {
                    log('‚ö† Aucun √©v√©nement existant, cr√©ation du fichier', 'warning');
                }

                // √âtape 2 : D√©duplication et fusion des √©v√©nements
                log('üîç V√©rification des doublons...', 'info');
                let duplicates = 0;
                let added = 0;
                const mergedEvents = [...existingEvents];

                for (const newEvent of events) {
                    // V√©rifier si un √©v√©nement similaire existe d√©j√†
                    // Doublon = m√™me date + m√™me lieu/adresse
                    const isDuplicate = existingEvents.some(existing =>
                        existing.date === newEvent.date &&
                        (existing.location.toLowerCase() === newEvent.location.toLowerCase() ||
                         existing.address.toLowerCase() === newEvent.address.toLowerCase() ||
                         existing.title.toLowerCase() === newEvent.title.toLowerCase())
                    );

                    if (isDuplicate) {
                        duplicates++;
                        log(`  ‚äò Doublon ignor√©: ${newEvent.title} (${newEvent.date})`, 'warning');
                    } else {
                        mergedEvents.push(newEvent);
                        added++;
                        log(`  + Ajout√©: ${newEvent.title} (${newEvent.date})`, 'success');
                    }
                }

                log(`\nüìä R√©sum√©:`, 'info');
                log(`  ‚Ä¢ ${duplicates} doublons √©vit√©s`, 'warning');
                log(`  ‚Ä¢ ${added} nouveaux √©v√©nements ajout√©s`, 'success');
                log(`  ‚Ä¢ ${mergedEvents.length} √©v√©nements au total`, 'info');

                // √âtape 3 : Commit via l'API
                log('üì§ Envoi vers GitHub...', 'info');

                const response = await fetch('/api/github-commit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filePath: 'cevennes-connect/data/events-data.json',
                        content: JSON.stringify(mergedEvents, null, 2),
                        commitMessage: `üéâ Artefact IA - Ajout de ${count} √©v√©nement(s)

${events.map((e, i) => `${i + 1}. ${e.title} - ${e.date} √† ${e.location}`).join('\n')}

ü§ñ Generated via admin-event-ai.html`
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Erreur inconnue');
                }

                const result = await response.json();
                log('‚úÖ Commit r√©ussi sur GitHub !', 'success');
                log(`   Commit SHA: ${result.commit.sha.substring(0, 7)}`, 'info');

                alert(`‚úÖ √âv√©nement(s) committ√©(s) sur GitHub !\n\nüìä ${count} √©v√©nement(s) trait√©(s)\n${duplicates} doublons √©vit√©s\n${added} nouveaux ajout√©s\nüìÇ Total: ${mergedEvents.length} √©v√©nements\n\nüéâ Les donn√©es sont en ligne !`);

            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error');
                alert(`‚ùå Erreur lors du commit:\n\n${error.message}\n\nVeuillez r√©essayer ou utiliser le t√©l√©chargement local.`);
            }
        }
    </script>
</body>
</html>
